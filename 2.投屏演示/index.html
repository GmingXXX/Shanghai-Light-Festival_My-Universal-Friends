<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®‡å®™æœ‹å‹åŠ¨æ€å£çº¸</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            overflow: hidden;
            background: #000;
            font-family: Arial, sans-serif;
        }

        /* èƒŒæ™¯è§†é¢‘æ ·å¼ */
        #background-video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            z-index: -1;
        }

        /* ç”»å¸ƒæ ·å¼ */
        #creature-canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            cursor: crosshair;
        }

        /* ä¸Šä¼ æŒ‰é’®æ ·å¼ */
        #upload-button {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 100;
            backdrop-filter: blur(5px);
        }

        #upload-button:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.8);
            color: white;
            transform: scale(1.1);
        }

        /* æ‹–æ‹½æ—¶çš„æ ·å¼ */
        body.drag-over {
            background: rgba(0, 150, 255, 0.1);
        }

        body.drag-over #upload-button {
            background: rgba(0, 150, 255, 0.5);
            border-color: rgba(0, 150, 255, 1);
            color: white;
            transform: scale(1.2);
        }

        /* åŠ è½½æç¤º */
        #loading-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            z-index: 200;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            display: none;
        }

        /* ä¿¡æ¯é¢æ¿ */
        #info-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            backdrop-filter: blur(5px);
        }

        /* å¸®åŠ©é¢æ¿ */
        #help-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            backdrop-filter: blur(5px);
            max-width: 300px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #help-panel.show {
            opacity: 1;
        }

        /* æ€§èƒ½è­¦å‘Š */
        .performance-warning {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 165, 0, 0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 300;
            text-align: center;
            display: none;
        }

        /* é»˜è®¤éšè—æ§ä»¶ï¼šä»…å±•ç¤ºæ•ˆæœç”»é¢ */
        #upload-button,
        #info-panel {
            display: none;
        }

        /* å¸®åŠ©é¢æ¿ä¸­çš„æ§ä»¶å¸ƒå±€ä¸æ ·å¼è¦†ç›– */
        #help-panel .in-help {
            position: static !important;
            top: auto; left: auto; right: auto; bottom: auto;
            z-index: auto;
            transform: none;
        }
        #help-panel #upload-button.in-help {
            display: flex;
            width: 40px;
            height: 40px;
            margin-top: 10px;
        }
        #help-panel #info-panel.in-help {
            display: block;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- èƒŒæ™¯è§†é¢‘ -->
    <video id="background-video" autoplay loop muted>
        <source src="background/UNIVERSE.mp4" type="video/mp4">
        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
    </video>

    <!-- æ ¸å¿ƒç”»å¸ƒ -->
    <canvas id="creature-canvas"></canvas>
    
    <!-- éšè—çš„æ–‡ä»¶ä¸Šä¼ è¾“å…¥ -->
    <input type="file" id="video-uploader" multiple accept=".webm" style="display: none;">
    
    <!-- ä¸Šä¼ æŒ‰é’®ï¼ˆé»˜è®¤éšè—ï¼Œç§»åŠ¨åˆ°å¸®åŠ©é¢æ¿æ˜¾ç¤ºï¼‰ -->
    <div id="upload-button" title="ç‚¹å‡»æˆ–æ‹–æ‹½webmæ–‡ä»¶åˆ°æ­¤å¤„æ·»åŠ å®‡å®™æœ‹å‹">+</div>

    <!-- åŠ è½½æç¤º -->
    <div id="loading-indicator">æ­£åœ¨åŠ è½½è§†é¢‘...</div>

    <!-- ä¿¡æ¯é¢æ¿ï¼ˆé»˜è®¤éšè—ï¼Œç§»åŠ¨åˆ°å¸®åŠ©é¢æ¿æ˜¾ç¤ºï¼‰ -->
    <div id="info-panel">
        <div>å®‡å®™æœ‹å‹æ•°é‡: <span id="creature-count">0</span></div>
        <div>FPS: <span id="fps-counter">0</span></div>
        <div>æ–‡ä»¶å¤¹ç›‘å¬: <span id="monitor-status">å¼€å¯</span></div>
        <div style="margin-top: 5px; font-size: 11px; opacity: 0.7;">æŒ‰ H é”®æ˜¾ç¤ºå¸®åŠ© | æŒ‰ F é”®ç«‹å³æ£€æµ‹ | æŒ‰ C é”®æ¸…é™¤å·²åˆ é™¤</div>
    </div>

    <!-- æ‰‹åŠ¨æ·»åŠ æ–‡ä»¶è¾“å…¥æ¡† -->
    <div id="manual-add-panel" style="position: fixed; top: 80px; left: 20px; background: rgba(0, 0, 0, 0.7); padding: 10px; border-radius: 5px; color: white; font-size: 12px; z-index: 100; display: none;">
        <div style="margin-bottom: 5px;">è¾“å…¥æ–°æ–‡ä»¶åï¼ˆä¸å«è·¯å¾„ï¼‰:</div>
        <input type="text" id="manual-filename" placeholder="ä¾‹å¦‚: test_1.webm" style="width: 200px; padding: 3px; margin-right: 5px;" onkeypress="if(event.key==='Enter') loadManualFile()">
        <button onclick="loadManualFile()" style="padding: 3px 8px; background: #0066cc; color: white; border: none; border-radius: 3px; cursor: pointer;">åŠ è½½</button>
        <button onclick="hideManualAddPanel()" style="padding: 3px 8px; background: #666; color: white; border: none; border-radius: 3px; cursor: pointer; margin-left: 5px;">å–æ¶ˆ</button>
    </div>

    <!-- å¸®åŠ©é¢æ¿ -->
    <div id="help-panel">
        <div><strong>å®‡å®™æœ‹å‹åŠ¨æ€å£çº¸ - æ“ä½œè¯´æ˜</strong></div>
        <div style="margin-top: 10px;">
            <div>â€¢ ç‚¹å‡»å³ä¸Šè§’ + æŒ‰é’®æˆ–æ‹–æ‹½æ–‡ä»¶ä¸Šä¼  webm è§†é¢‘</div>
            <div>â€¢ æ”¯æŒé€æ˜èƒŒæ™¯çš„ webm æ ¼å¼è§†é¢‘æ–‡ä»¶</div>
            <div>â€¢ ğŸš€ è‡ªåŠ¨ç›‘å¬ï¼šæ¯3ç§’æ‰«æï¼Œå¯åœ¨æ­¤å¤„è®¾ç½®è‡ªå®šä¹‰é—´éš”</div>
            <div>â€¢ ğŸ“‚ æ£€æµ‹èŒƒå›´ï¼š1-999.webm, a-z.webm, Character_00001-00100_transparent.webm</div>
            <div>â€¢ æœ€å¤šåŒæ—¶æ˜¾ç¤º 100 ä¸ªå®‡å®™æœ‹å‹</div>
            <div>â€¢ å•ä¸ªæ–‡ä»¶å¤§å°é™åˆ¶ 50MB</div>
            <div>â€¢ æŒ‰ H é”®æ˜¾ç¤º/éšè—æ­¤å¸®åŠ©</div>
            <div>â€¢ æŒ‰ M é”®å¼€å¯/å…³é—­æ–‡ä»¶å¤¹ç›‘å¬</div>
            <div>â€¢ æŒ‰ F é”®ç«‹å³æ£€æµ‹æ–°å¢è§†é¢‘æ–‡ä»¶</div>
            <div>â€¢ æŒ‰ C é”®æ¸…é™¤å·²åˆ é™¤çš„æ–‡ä»¶å¯¹åº”çš„å®‡å®™æœ‹å‹</div>
        </div>
        <div style="margin-top: 10px; border-top: 1px dashed rgba(255,255,255,0.2); padding-top: 10px;">
            <div style="margin-bottom: 6px; opacity: 0.9;">ç•Œé¢æ§ä»¶ï¼š</div>
            <!-- å°†ä¸Šä¼ æŒ‰é’®ä¸ä¿¡æ¯é¢æ¿åµŒå…¥å¸®åŠ©é¢æ¿ -->
            <div id="help-controls" style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                <!-- upload-button ä¸ info-panel å°†åœ¨è„šæœ¬ä¸­ç§»åŠ¨åˆ°è¿™é‡Œ -->
            </div>
            <div id="monitor-settings" style="margin-top: 10px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                <div style="opacity:0.9;">ç›‘å¬é—´éš”(ç§’):</div>
                <input type="number" id="monitor-interval-input" min="1" max="60" step="1" value="3" style="width: 60px; padding: 3px;">
                <button id="apply-interval-btn" style="padding: 3px 8px; background: #00aa88; color: white; border: none; border-radius: 3px; cursor: pointer;">åº”ç”¨</button>
                <div id="current-interval-text" style="opacity: 0.8;">å½“å‰: 3s</div>
            </div>
            <div id="limit-settings" style="margin-top: 10px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                <div style="opacity:0.9;">é¡µé¢è§†é¢‘ä¸Šé™:</div>
                <input type="number" id="creature-limit-input" min="1" max="100" step="1" value="50" style="width: 60px; padding: 3px;">
                <button id="apply-limit-btn" style="padding: 3px 8px; background: #ffaa00; color: white; border: none; border-radius: 3px; cursor: pointer;">åº”ç”¨</button>
                <div id="current-limit-text" style="opacity: 0.8;">å½“å‰: 50</div>
            </div>
            <div id="fs-access-controls" style="margin-top: 10px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                <button id="grant-dir-access-btn" style="padding: 3px 8px; background: #8844ff; color: white; border: none; border-radius: 3px; cursor: pointer;">æˆæƒç›‘æ§ video æ–‡ä»¶å¤¹</button>
                <div id="dir-access-status" style="opacity: 0.8;">ç›®å½•è®¿é—®ï¼šæœªæˆæƒ</div>
            </div>
        </div>
    </div>

    <!-- æ€§èƒ½è­¦å‘Š -->
    <div id="performance-warning" class="performance-warning">
        <div><strong>æ€§èƒ½è­¦å‘Š</strong></div>
        <div style="margin-top: 10px;">
            æ£€æµ‹åˆ°æ€§èƒ½ä¸‹é™ (FPS < 30)ï¼Œå»ºè®®å‡å°‘å®‡å®™æœ‹å‹æ•°é‡ä»¥è·å¾—æ›´å¥½çš„ä½“éªŒã€‚
        </div>
        <button onclick="this.parentElement.style.display='none'" style="margin-top: 10px; padding: 5px 10px; background: white; color: orange; border: none; border-radius: 5px; cursor: pointer;">çŸ¥é“äº†</button>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let canvas, ctx;
        let creatures = [];
        let animationId;
        let lastTime = 0;
        let frameCount = 0;
        let lastFpsUpdate = 0;
        let globalTime = 0; // rAF æä¾›çš„æ—¶é—´ï¼ˆç§’ï¼‰
        
        // æ–‡ä»¶å¤¹ç›‘å¬ç›¸å…³å˜é‡
        let knownVideoFiles = new Set(); // å­˜å‚¨å·²çŸ¥çš„è§†é¢‘æ–‡ä»¶
        let videoMonitorInterval = null; // ç›‘å¬å®šæ—¶å™¨
        let isMonitoring = false; // ç›‘å¬çŠ¶æ€ï¼ˆé»˜è®¤å…³é—­ï¼Œæ”¹ä¸ºæ‰‹åŠ¨æ¨¡å¼ï¼‰
        let userAddedFiles = new Set(); // ç”¨æˆ·æ‰‹åŠ¨æ·»åŠ çš„æ–‡ä»¶åˆ—è¡¨
        let monitorIntervalMs = 3000; // é»˜è®¤3ç§’ç›‘å¬é—´éš”
        const MONITOR_INTERVAL_STORAGE_KEY = 'monitorIntervalSeconds';
        let loadedFilenames = new Set(); // å·²åŠ è½½çš„æ–‡ä»¶åï¼Œç”¨äºå»é‡ä¸æ¸…ç†
        let loadingFilenames = new Set(); // æ­£åœ¨åŠ è½½çš„æ–‡ä»¶åï¼Œé¿å…å¹¶å‘é‡å¤
        let playbackWatchdogInterval = null; // æ’­æ”¾å®ˆæŠ¤å®šæ—¶å™¨
        let playbackGuardsInitialized = false; // å…¨å±€å¯è§æ€§å®ˆæŠ¤æ˜¯å¦åˆå§‹åŒ–
        let dirHandle = null; // File System Access API ç›®å½•å¥æŸ„
        let useFsAccess = false; // æ˜¯å¦å¯ç”¨ç›®å½•ç›´è¯»æ¨¡å¼
        const LOOP_WRAP_THRESHOLD = 0.25; // è·å°¾å¸§é˜ˆå€¼ï¼ˆç§’ï¼‰ï¼Œæå‰é‡æ’­é¿å…åœé¡¿ï¼ˆæå‡å®¹é”™ï¼‰
        const SHOW_PERFORMANCE_WARNING = false; // å…³é—­æ€§èƒ½è­¦å‘Šå¼¹çª—
        const STALL_NUDGE_SECONDS = 1.5; // åˆ¤å®šå¡ä½çš„é˜ˆå€¼ï¼ˆç§’ï¼‰
        const NUDGE_JUMP_SECONDS = 0.05; // è½»æ¨æ’­æ”¾çš„è·³è½¬ç§’æ•°
        
        // é¡µé¢è§†é¢‘ä¸Šé™è®¾ç½®
        let creatureLimit = 50; // é»˜è®¤ä¸Šé™ 50
        const CREATURE_LIMIT_STORAGE_KEY = 'creatureLimit';
        let isPruningCreatures = false; // é˜²æ­¢é€’å½’è£å‰ª

        // åˆå§‹åŒ–
        function init() {
            canvas = document.getElementById('creature-canvas');
            ctx = canvas.getContext('2d');
            
            // è®¾ç½®ç”»å¸ƒå¤§å°
            resizeCanvas();
            
            // ç›‘å¬çª—å£å¤§å°å˜åŒ–
            window.addEventListener('resize', resizeCanvas);
            
            // è®¾ç½®æ–‡ä»¶ä¸Šä¼ äº‹ä»¶
            setupFileUpload();
            
            // è®¾ç½®é”®ç›˜å¿«æ·é”®
            setupKeyboardShortcuts();
            
            // è®¾ç½®ç”»å¸ƒç‚¹å‡»äº‹ä»¶ï¼ˆç”¨äºè§¦å‘è§†é¢‘æ’­æ”¾ï¼‰
            setupCanvasClick();
            
            // å¼€å§‹åŠ¨ç”»å¾ªç¯
            animate();
            
            // åˆå§‹åŒ–ç›‘å¬é—´éš”ä¸è®¾ç½®UI
            loadMonitorIntervalFromStorage();
            setupMonitorControlsUI();
            // åˆå§‹åŒ–é¡µé¢è§†é¢‘ä¸Šé™è®¾ç½®
            loadCreatureLimitFromStorage();
            setupLimitControlsUI();
            setupGlobalPlaybackGuards();
            
            // åˆå§‹åŒ–ï¼šè‹¥æˆæƒäº†ç›®å½•ï¼Œåˆ™é‡‡ç”¨ç›®å½•æšä¸¾åˆå§‹åŒ–ï¼›å¦åˆ™æ‰§è¡Œè½»é‡æ‰«æ
            if (useFsAccess && dirHandle) {
                enumerateDirectoryAndLoad();
            } else {
                performInitialScan();
            }
            
            // é»˜è®¤å¼€å¯è‡ªåŠ¨ç›‘å¬
            startVideoMonitoring();
            updateMonitorStatus();
            
            // æ£€æµ‹åè®®å¹¶ç»™å‡ºç›¸åº”æç¤º
            checkProtocolAndNotify();
            
            console.log('å®‡å®™æœ‹å‹åŠ¨æ€å£çº¸åˆå§‹åŒ–å®Œæˆ - è‡ªåŠ¨ç›‘å¬æ¨¡å¼');
        }

        // è®¾ç½®é”®ç›˜å¿«æ·é”® - æ€§èƒ½ä¼˜åŒ–ç‰ˆæœ¬
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // é˜²æŠ–å¤„ç†ï¼Œé¿å…å¿«é€ŸæŒ‰é”®å¯¼è‡´çš„é‡å¤æ‰§è¡Œ
                if (e.repeat) return;
                
                switch(e.key.toLowerCase()) {
                    case 'h':
                        toggleHelp();
                        break;
                    case 'c':
                        // å¼‚æ­¥æ‰§è¡Œï¼Œé¿å…é˜»å¡UI
                        setTimeout(() => cleanupDeletedFiles(), 0);
                        break;
                    case 'r':
                        resetCanvas();
                        break;
                    case 'p':
                        playAllVideos();
                        break;
                    case 'm':
                        toggleVideoMonitoring();
                        break;
                    case 'f':
                        // å¼‚æ­¥æ‰§è¡Œï¼Œé¿å…é˜»å¡UI
                        setTimeout(() => manualRefreshVideoFolder(), 0);
                        break;
                    case 'a':
                        showManualAddPanel();
                        break;
                    case 'u':
                        // å¼‚æ­¥æ‰§è¡Œï¼Œé¿å…é˜»å¡UI
                        setTimeout(() => updateFileList(), 0);
                        break;
                    case 'g':
                        // Gé”®ï¼šå¿«é€Ÿå¼¹å‡ºç›®å½•æˆæƒ
                        setTimeout(() => requestDirectoryAccess(), 0);
                        break;
                    case 'escape':
                        hideHelp();
                        hideManualAddPanel();
                        break;
                    case 'd':
                        debugCreatures();
                        break;
                    case 't':
                        // Té”®ï¼šæµ‹è¯•æ£€æµ‹åŠŸèƒ½
                        setTimeout(() => testDetection(), 0);
                        break;
                    case 's':
                        // Sé”®ï¼šå¼ºåˆ¶å…¨é¢æ‰«æ
                        setTimeout(() => forceFullScan(), 0);
                        break;
                }
            });
        }

        // æ’­æ”¾æ‰€æœ‰è§†é¢‘
        function playAllVideos() {
            creatures.forEach(creature => {
                if (creature.video.paused) {
                    creature.video.play().catch(e => {
                        console.warn('æ— æ³•æ’­æ”¾è§†é¢‘:', e);
                    });
                }
            });
            console.log('å°è¯•æ’­æ”¾æ‰€æœ‰è§†é¢‘');
        }

        // è®¾ç½®ç”»å¸ƒç‚¹å‡»äº‹ä»¶
        function setupCanvasClick() {
            canvas.addEventListener('click', () => {
                playAllVideos();
            });
        }

        // åˆ‡æ¢å¸®åŠ©é¢æ¿æ˜¾ç¤º
        function toggleHelp() {
            const helpPanel = document.getElementById('help-panel');
            helpPanel.classList.toggle('show');
            relocateControls(helpPanel.classList.contains('show'));
        }

        // éšè—å¸®åŠ©é¢æ¿
        function hideHelp() {
            const helpPanel = document.getElementById('help-panel');
            helpPanel.classList.remove('show');
            relocateControls(false);
        }

        // å°†ä¸Šä¼ æŒ‰é’®ä¸ä¿¡æ¯é¢æ¿ç§»åŠ¨åˆ°å¸®åŠ©é¢æ¿ä¸­/è¿˜åŸ
        function relocateControls(showing) {
            const helpControls = document.getElementById('help-controls');
            const uploadBtn = document.getElementById('upload-button');
            const infoPanel = document.getElementById('info-panel');
            if (!helpControls || !uploadBtn || !infoPanel) return;

            if (showing) {
                if (!helpControls.contains(uploadBtn)) {
                    uploadBtn.classList.add('in-help');
                    helpControls.appendChild(uploadBtn);
                }
                if (!helpControls.contains(infoPanel)) {
                    infoPanel.classList.add('in-help');
                    helpControls.appendChild(infoPanel);
                }
                // æ˜¾ç¤ºå¸®åŠ©å†…çš„æ§ä»¶
                uploadBtn.style.display = 'flex';
                infoPanel.style.display = 'block';
                // ç»‘å®šæˆæƒæŒ‰é’®äº‹ä»¶
                const grantBtn = document.getElementById('grant-dir-access-btn');
                if (grantBtn && !grantBtn.dataset.bound) {
                    grantBtn.addEventListener('click', requestDirectoryAccess);
                    grantBtn.dataset.bound = '1';
                }
            } else {
                // éšè—æ§ä»¶ï¼ˆä¸å†å æ®ç”»é¢ï¼‰
                uploadBtn.style.display = 'none';
                infoPanel.style.display = 'none';
            }
        }

        // æ¸…é™¤æ‰€æœ‰å®‡å®™æœ‹å‹
        function clearAllCreatures() {
            if (creatures.length === 0) return;
            
            if (confirm(`ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ ${creatures.length} ä¸ªå®‡å®™æœ‹å‹å—ï¼Ÿ`)) {
                // é‡Šæ”¾è§†é¢‘èµ„æº
                creatures.forEach(creature => {
                    if (creature.video.src) {
                        URL.revokeObjectURL(creature.video.src);
                    }
                });
                
                creatures = [];
                updateCreatureCount();
                console.log('å·²æ¸…é™¤æ‰€æœ‰å®‡å®™æœ‹å‹');
            }
        }

        // é‡ç½®ç”»å¸ƒ
        function resetCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            console.log('ç”»å¸ƒå·²é‡ç½®');
        }

        // è°ƒæ•´ç”»å¸ƒå¤§å°
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        // æµ·æ´‹ç”Ÿç‰©ç±»
        class Creature {
            constructor(videoElement) {
                this.video = videoElement;
                
                // æ ¹æ®è§†é¢‘åŸå§‹å°ºå¯¸è®¡ç®—æ˜¾ç¤ºå°ºå¯¸ï¼Œä½†é™åˆ¶åœ¨åˆç†èŒƒå›´å†…
                const aspectRatio = videoElement.videoWidth / videoElement.videoHeight;
                const baseSize = Math.random() * 104 + 78; // 78-182pxï¼ˆè¾ƒåŸæ¥ä¸Š/ä¸‹é™+30%ï¼‰
                this.width = baseSize;
                this.height = baseSize / aspectRatio;
                
                // é™åˆ¶é«˜åº¦ï¼Œé¿å…è¿‡é«˜æˆ–è¿‡å®½çš„è§†é¢‘
                if (this.height > 260) {
                    this.height = 260;
                    this.width = this.height * aspectRatio;
                }
                if (this.width > 390) {
                    this.width = 390;
                    this.height = this.width / aspectRatio;
                }
                
                // éšæœºåˆå§‹ä½ç½®ï¼ˆç¡®ä¿å®Œå…¨åœ¨ç”»å¸ƒå†…ï¼‰
                this.x = Math.random() * Math.max(0, canvas.width - this.width);
                this.y = Math.random() * Math.max(0, canvas.height - this.height);
                
                // æå…¶ç¼“æ…¢çš„éšæœºé€Ÿåº¦ï¼Œæ¨¡æ‹Ÿæµ·æ´‹ç”Ÿç‰©çš„æ‚ é—²æ¸¸åŠ¨ï¼ˆæ•´ä½“å‡åŠï¼‰
                const speedFactor = 0.15; // åŸ 0.3
                this.dx = (Math.random() - 0.5) * speedFactor;
                this.dy = (Math.random() - 0.5) * speedFactor;
                
                // ç¡®ä¿æœ€å°é€Ÿåº¦ï¼Œé¿å…é™æ­¢ï¼ˆæ›´å°ï¼‰
                const minSpeed = 0.025; // åŸ 0.05
                if (Math.abs(this.dx) < minSpeed) this.dx = this.dx >= 0 ? minSpeed : -minSpeed;
                if (Math.abs(this.dy) < minSpeed) this.dy = this.dy >= 0 ? minSpeed : -minSpeed;
                
                // æ·»åŠ ä¸€äº›éšæœºæ€§ï¼šå¶å°”æ”¹å˜æ–¹å‘çš„è®¡æ—¶å™¨
                this.directionChangeTimer = Math.random() * 400 + 400; // 400-800å¸§åæ”¹å˜æ–¹å‘
                this.directionChangeCounter = 0;
                
                // é€æ˜åº¦ï¼ˆå¯é€‰ï¼šæ·»åŠ ä¸€äº›è§†è§‰å˜åŒ–ï¼‰
                this.opacity = 0.7 + Math.random() * 0.2; // 0.7-0.9ï¼ˆæ•´ä½“æ›´ä½ä»¥é…åˆä¸‹é™0.30ï¼‰

                // è½»å¾®åŠ¨æ€å˜æ¢å‚æ•°ï¼ˆæ­£å¼¦ LFOï¼‰
                this.scalePhase = Math.random() * Math.PI * 2;
                this.scaleSpeed = 0.2 + Math.random() * 0.25; // 0.2 - 0.45ï¼ˆæ›´ä»å®¹ï¼‰
                this.scaleAmp = 0.25 + Math.random() * 0.2; // 25% - 45%

                this.rotatePhase = Math.random() * Math.PI * 2;
                this.rotateSpeed = 0.125 + Math.random() * 0.15; // 0.125 - 0.275
                this.rotateAmp = (Math.PI / 180) * (1 + Math.random() * 2); // 1Â° - 3Â°

                this.alphaPhase = Math.random() * Math.PI * 2;
                this.alphaSpeed = 0.4 + Math.random() * 0.6; // 0.4 - 1.0ï¼ˆå‡åŠï¼‰
                this.alphaAmp = 0.0; // ä¸ç›´æ¥ä½¿ç”¨å¯¹ç§°å¹…åº¦
                // éå¯¹ç§°é€æ˜åº¦å¹…åº¦ï¼šé™ä½æ•´ä½“å¹…åº¦ï¼Œé…åˆä¸‹é™0.30
                this.alphaAmpPos = 0.10 + Math.random() * 0.15; // 0.10 - 0.25
                this.alphaAmpNeg = 0.25 + Math.random() * 0.25; // 0.25 - 0.50
            }

            update() {
                // æ›´æ–°ä½ç½®
                this.x += this.dx;
                this.y += this.dy;

                // æ–¹å‘æ”¹å˜é€»è¾‘ï¼šæ¨¡æ‹Ÿæµ·æ´‹ç”Ÿç‰©çš„è‡ªç„¶æ¸¸åŠ¨
                this.directionChangeCounter++;
                if (this.directionChangeCounter >= this.directionChangeTimer) {
                    // è½»å¾®æ”¹å˜æ–¹å‘ï¼Œè€Œä¸æ˜¯å®Œå…¨éšæœºï¼ˆæ›´å°å¹…åº¦ï¼‰
                    const changeIntensity = 0.05; // åŸ 0.1
                    this.dx += (Math.random() - 0.5) * changeIntensity;
                    this.dy += (Math.random() - 0.5) * changeIntensity;
                    
                    // é™åˆ¶æœ€å¤§é€Ÿåº¦ï¼ˆæ›´ä½ä¸Šé™ï¼‰
                    const maxSpeed = 0.4; // åŸ 0.8
                    if (Math.abs(this.dx) > maxSpeed) this.dx = this.dx > 0 ? maxSpeed : -maxSpeed;
                    if (Math.abs(this.dy) > maxSpeed) this.dy = this.dy > 0 ? maxSpeed : -maxSpeed;
                    
                    // é‡ç½®è®¡æ—¶å™¨
                    this.directionChangeTimer = Math.random() * 400 + 600; // 600-1000å¸§
                    this.directionChangeCounter = 0;
                }

                // è¾¹ç•Œç¢°æ’æ£€æµ‹å’Œåå¼¹
                if (this.x <= 0) {
                    this.dx = Math.abs(this.dx);
                    this.x = 0;
                } else if (this.x + this.width >= canvas.width) {
                    this.dx = -Math.abs(this.dx);
                    this.x = canvas.width - this.width;
                }
                
                if (this.y <= 0) {
                    this.dy = Math.abs(this.dy);
                    this.y = 0;
                } else if (this.y + this.height >= canvas.height) {
                    this.dy = -Math.abs(this.dy);
                    this.y = canvas.height - this.height;
                }
            }

            draw() {
                // æ›´å®½æ¾çš„ç»˜åˆ¶æ¡ä»¶ï¼šåªè¦è§†é¢‘æœ‰æ•°æ®å°±å°è¯•ç»˜åˆ¶
                if (this.video.readyState >= 1) { // HAVE_METADATA æˆ–æ›´é«˜
                    try {
                        // ä¿å­˜å½“å‰ä¸Šä¸‹æ–‡çŠ¶æ€
                        ctx.save();

                        // åŸºäºå…¨å±€æ—¶é—´çš„è½»å¾®æ­£å¼¦å˜æ¢
                        const t = globalTime; // ç§’
                        const scale = 1 + this.scaleAmp * Math.sin(t * this.scaleSpeed + this.scalePhase);
                        const rotation = this.rotateAmp * Math.sin(t * this.rotateSpeed + this.rotatePhase);
                        const s = Math.sin(t * this.alphaSpeed + this.alphaPhase);
                        const alphaMod = s >= 0 ? s * this.alphaAmpPos : s * this.alphaAmpNeg;
                        const alpha = Math.max(0.30, Math.min(1, this.opacity + alphaMod));

                        // è®¾ç½®é€æ˜åº¦
                        ctx.globalAlpha = alpha;

                        // å›´ç»•ä¸­å¿ƒè¿›è¡Œæ—‹è½¬ä¸ç¼©æ”¾
                        const cx = this.x + this.width / 2;
                        const cy = this.y + this.height / 2;
                        ctx.translate(cx, cy);
                        ctx.rotate(rotation);
                        ctx.scale(scale, scale);

                        // ç»˜åˆ¶è§†é¢‘å¸§ï¼ˆä»¥ä¸­å¿ƒä¸ºåŸç‚¹ï¼‰
                        ctx.drawImage(this.video, -this.width / 2, -this.height / 2, this.width, this.height);

                        // æ¢å¤ä¸Šä¸‹æ–‡çŠ¶æ€
                        ctx.restore();
                        
                        // å¦‚æœè§†é¢‘æš‚åœäº†ï¼Œå°è¯•é‡æ–°æ’­æ”¾
                        if (this.video.paused && this.video.readyState >= 2) {
                            this.video.play().catch(e => {
                                // é™é»˜å¤„ç†æ’­æ”¾å¤±è´¥
                            });
                        }
                    } catch (e) {
                        // ç»˜åˆ¶å¤±è´¥æ—¶çš„è°ƒè¯•ä¿¡æ¯
                        console.warn(`ç»˜åˆ¶è§†é¢‘å¸§å¤±è´¥:`, e, `readyState: ${this.video.readyState}, paused: ${this.video.paused}`);
                    }
                }
            }
        }

        // è®¾ç½®æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
        function setupFileUpload() {
            const uploadButton = document.getElementById('upload-button');
            const videoUploader = document.getElementById('video-uploader');
            const loadingIndicator = document.getElementById('loading-indicator');

            // ç‚¹å‡»ä¸Šä¼ æŒ‰é’®
            uploadButton.addEventListener('click', () => {
                videoUploader.click();
            });

            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            videoUploader.addEventListener('change', handleFiles);

            // æ‹–æ‹½äº‹ä»¶
            document.addEventListener('dragover', (e) => {
                e.preventDefault();
                document.body.classList.add('drag-over');
            });

            document.addEventListener('dragleave', (e) => {
                if (e.clientX === 0 && e.clientY === 0) {
                    document.body.classList.remove('drag-over');
                }
            });

            document.addEventListener('drop', (e) => {
                e.preventDefault();
                document.body.classList.remove('drag-over');
                handleFiles({ target: { files: e.dataTransfer.files } });
            });
        }

        // å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶
        function handleFiles(event) {
            const files = event.target.files;
            const loadingIndicator = document.getElementById('loading-indicator');
            
            if (files.length === 0) return;

            // æ£€æŸ¥æ–‡ä»¶æ•°é‡é™åˆ¶ï¼ˆé˜²æ­¢æ€§èƒ½é—®é¢˜ï¼‰
            const maxFiles = 100;
            if (creatures.length + files.length > maxFiles) {
                alert(`ä¸ºäº†ä¿è¯æ€§èƒ½ï¼Œæœ€å¤šåªèƒ½åŒæ—¶æ˜¾ç¤º ${maxFiles} ä¸ªå®‡å®™æœ‹å‹ã€‚å½“å‰å·²æœ‰ ${creatures.length} ä¸ªã€‚`);
                return;
            }

            loadingIndicator.style.display = 'block';
            let loadedCount = 0;
            const totalFiles = files.length;
            let validFiles = 0;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // æ£€æŸ¥æ–‡ä»¶ç±»å‹å’Œå¤§å°
                if (!file.type.includes('webm')) {
                    console.warn(`è·³è¿‡éwebmæ–‡ä»¶: ${file.name}`);
                    loadedCount++;
                    checkComplete();
                    continue;
                }

                // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º50MBï¼‰
                if (file.size > 50 * 1024 * 1024) {
                    console.warn(`æ–‡ä»¶è¿‡å¤§ï¼Œè·³è¿‡: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)`);
                    loadedCount++;
                    checkComplete();
                    continue;
                }

                validFiles++;
                const videoUrl = URL.createObjectURL(file);
                const video = document.createElement('video');
                
                video.src = videoUrl;
                video.loop = true;
                video.muted = true;
                video.autoplay = true;
                video.preload = 'auto'; // æ”¹å›autoç¡®ä¿è§†é¢‘å®Œå…¨åŠ è½½
                video.crossOrigin = 'anonymous';
                video.playsInline = true; // ç¡®ä¿åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šå†…è”æ’­æ”¾

                // è®¾ç½®åŠ è½½è¶…æ—¶
                const timeoutId = setTimeout(() => {
                    console.error(`è§†é¢‘åŠ è½½è¶…æ—¶: ${file.name}`);
                    loadedCount++;
                    checkComplete();
                }, 10000);

            let handled = false;
            const onUploadSuccess = () => {
                if (handled) return;
                clearTimeout(timeoutId);
                if (video.videoWidth === 0 || video.videoHeight === 0) {
                    console.error(`æ— æ•ˆçš„è§†é¢‘å°ºå¯¸: ${file.name}`);
                    URL.revokeObjectURL(videoUrl);
                    loadedCount++;
                    checkComplete();
                    return;
                }
                handled = true;
                video.play().catch(() => {});
                const creature = new Creature(video);
                creatures.push(creature);
                updateCreatureCount();
                loadedCount++;
                checkComplete();
                console.log(`åŠ è½½å®‡å®™æœ‹å‹: ${file.name} (${video.videoWidth}x${video.videoHeight})`);
            };
            video.addEventListener('loadedmetadata', onUploadSuccess);
            video.addEventListener('canplay', onUploadSuccess);
            video.addEventListener('loadeddata', onUploadSuccess);

                video.addEventListener('error', (e) => {
                    clearTimeout(timeoutId);
                    console.error(`è§†é¢‘åŠ è½½å¤±è´¥: ${file.name}`, e);
                    URL.revokeObjectURL(videoUrl);
                    loadedCount++;
                    checkComplete();
                });
            }

            function checkComplete() {
                if (loadedCount === totalFiles) {
                    loadingIndicator.style.display = 'none';
                    if (validFiles > 0) {
                        console.log(`æˆåŠŸåŠ è½½ ${creatures.length} ä¸ªå®‡å®™æœ‹å‹`);
                    }
                }
            }

            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            event.target.value = '';
        }

        // æ›´æ–°ç”Ÿç‰©æ•°é‡æ˜¾ç¤º
        function updateCreatureCount() {
            document.getElementById('creature-count').textContent = creatures.length;
            // è¶…è¿‡ä¸Šé™æ—¶æ‰§è¡Œè£å‰ª
            enforceCreatureLimit();
        }

        // æ‰§è¡Œåˆå§‹æ‰«æ - è½»é‡çº§å¿«é€Ÿæ‰«æ
        async function performInitialScan() {
            console.log('ğŸ” å¼€å§‹è½»é‡çº§åˆå§‹æ‰«æ...');
            
            // ç”Ÿæˆç®€åŒ–çš„æ£€æµ‹åˆ—è¡¨
            const targetFiles = generateSimpleFileList();
            
            console.log(`ğŸ¯ å¿«é€Ÿæ£€æµ‹ ${targetFiles.length} ä¸ªå¸¸è§æ–‡ä»¶æ¨¡å¼...`);
            console.log('âš¡ ç­–ç•¥ï¼šè½»é‡çº§æ‰«æï¼Œä¼˜å…ˆæ£€æµ‹å¸¸ç”¨æ–‡ä»¶å');
            
            let foundCount = 0;
            
            // ç®€åŒ–çš„å¹¶å‘æ£€æµ‹ï¼Œæ— å»¶è¿Ÿ
            const checkPromises = targetFiles.map(filename => checkVideoFile(filename));
            await Promise.all(checkPromises);
            
            const validFiles = Array.from(knownVideoFiles).filter(f => !f.endsWith('_not_found'));
            foundCount = validFiles.length;
            
            console.log(`âœ… åˆå§‹æ‰«æå®Œæˆï¼å‘ç° ${foundCount} ä¸ªç°æœ‰è§†é¢‘æ–‡ä»¶`);
            console.log('ğŸ“‹ å‘ç°çš„æ–‡ä»¶:', validFiles.sort());
            
            if (foundCount > 0) {
                showNewVideoNotification(`åˆå§‹åŒ–å®Œæˆï¼šå‘ç° ${foundCount} ä¸ªç°æœ‰è§†é¢‘`);
            } else {
                showNewVideoNotification('åˆå§‹åŒ–å®Œæˆï¼švideoæ–‡ä»¶å¤¹ä¸­æš‚æ— webmæ–‡ä»¶');
            }
        }

        // ç”Ÿæˆç®€åŒ–çš„æ–‡ä»¶æ‰«æåˆ—è¡¨ - åªæ£€æµ‹å¸¸ç”¨æ–‡ä»¶å
        function generateSimpleFileList() {
            const targetFiles = [];
            
            console.log('ğŸ“‹ ç”Ÿæˆç®€åŒ–çš„æ–‡ä»¶æ£€æµ‹åˆ—è¡¨...');
            
            // 1. æ•°å­—å‘½åæ–‡ä»¶ (1-999)
            for (let i = 1; i <= 999; i++) {
                targetFiles.push(`${i}.webm`);
            }
            
            // 2. å­—æ¯å‘½åæ–‡ä»¶ (a-z)
            for (let i = 97; i <= 122; i++) { // a-z
                targetFiles.push(`${String.fromCharCode(i)}.webm`);
            }
            
            // 3. Characterç³»åˆ—æ–‡ä»¶ (Character_00001_transparentåˆ°Character_00100_transparent)
            for (let i = 1; i <= 100; i++) {
                const num = String(i).padStart(5, '0');
                targetFiles.push(`Character_${num}_transparent.webm`);
            }
            
            // 4. å¸¸è§æ–‡ä»¶å
            const commonFiles = [
                'test.webm', 'demo.webm', 'new.webm', 'temp.webm', 'video.webm',
                'clip.webm', 'movie.webm', 'render.webm', 'output.webm', 'final.webm',
                'sample.webm', 'animation.webm', 'character.webm', 'dasdas.webm'
            ];
            targetFiles.push(...commonFiles);
            
            console.log(`ğŸ“Š ç”Ÿæˆäº† ${targetFiles.length} ä¸ªæ£€æµ‹ç›®æ ‡ï¼ˆè½»é‡çº§ï¼‰`);
            
            return targetFiles;
        }

        // å¯åŠ¨è§†é¢‘æ–‡ä»¶å¤¹ç›‘å¬ - è½»é‡çº§æ¨¡å¼
        function startVideoMonitoring() {
            if (isMonitoring) return;
            
            isMonitoring = true;
            console.log('ğŸš€ å¯åŠ¨è½»é‡çº§ç›‘å¬æ¨¡å¼...');
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            updateMonitorStatus();
            
            // è½»é‡çº§ç›‘å¬ï¼šä½¿ç”¨å¯é…ç½®é—´éš”
            console.log(`âš¡ è½»é‡çº§ç›‘å¬é—´éš”: ${monitorIntervalMs}ms`);
            console.log(`ğŸ”¥ è½»é‡çº§ç›‘å¬å·²å¯ç”¨ï¼Œæ–°webmæ–‡ä»¶å°†åœ¨${Math.round(monitorIntervalMs/1000)}ç§’å†…è¢«æ£€æµ‹åˆ°`);
            
            videoMonitorInterval = setInterval(() => {
                if (useFsAccess && dirHandle) {
                    enumerateDirectoryAndLoad();
                } else {
                    quickScanNewFiles();
                }
            }, monitorIntervalMs);
            // ç«‹å³è¿›è¡Œä¸€æ¬¡æ‰«æ
            if (useFsAccess && dirHandle) {
                enumerateDirectoryAndLoad();
            } else {
                quickScanNewFiles();
            }
        }

        // å¿«é€Ÿæ‰«ææ–°æ–‡ä»¶ - è½»é‡çº§ç‰ˆæœ¬
        async function quickScanNewFiles() {
            const targetFiles = generateSimpleFileList();
            
            // æ£€æµ‹æœªçŸ¥æ–‡ä»¶ï¼Œä¸”å¯¹æ›¾æ ‡è®°ä¸ºæœªæ‰¾åˆ°çš„æ–‡ä»¶è¿›è¡Œé‡è¯•
            const checkPromises = targetFiles.map(filename => {
                if (!knownVideoFiles.has(filename)) {
                    if (knownVideoFiles.has(`${filename}_not_found`)) {
                        return recheckPreviouslyNotFound(filename);
                    }
                    return checkVideoFile(filename);
                }
                return Promise.resolve();
            });
            
            await Promise.all(checkPromises);
        }

        // å¯¹æ­¤å‰æ ‡è®°ä¸ºæœªæ‰¾åˆ°çš„æ–‡ä»¶è¿›è¡Œé‡è¯•æ£€æµ‹
        async function recheckPreviouslyNotFound(filename) {
            return new Promise((resolve) => {
                const testVideo = document.createElement('video');
                testVideo.preload = 'metadata';
                testVideo.muted = true;
                testVideo.style.display = 'none';
                if (window.location.protocol !== 'file:') {
                    testVideo.crossOrigin = 'anonymous';
                }

                let resolved = false;
                const TIMEOUT_MS = window.location.protocol === 'file:' ? 2000 : 800;
                const timeoutId = setTimeout(() => {
                    if (!resolved) {
                        resolved = true;
                        clearTimeout(timeoutId);
                        // ä»æœªæ‰¾åˆ°åˆ—è¡¨ä¸­ç§»é™¤å¹¶æ ‡è®°ä¸ºå·²å‘ç°
                        knownVideoFiles.delete(`${filename}_not_found`);
                        knownVideoFiles.add(filename);
                        console.log(`âœ… å‘ç°æ­¤å‰ä¸å­˜åœ¨çš„æ–‡ä»¶: ${filename}`);
                        loadNewVideoFile(`video/${filename}`, filename);
                        resolve();
                    }
                }, TIMEOUT_MS);

                const successHandler = () => {
                    if (!resolved) {
                        resolved = true;
                        clearTimeout(timeoutId);
                        // ä»æœªæ‰¾åˆ°åˆ—è¡¨ä¸­ç§»é™¤å¹¶æ ‡è®°ä¸ºå·²å‘ç°
                        knownVideoFiles.delete(`${filename}_not_found`);
                        knownVideoFiles.add(filename);
                        console.log(`âœ… å‘ç°æ­¤å‰ä¸å­˜åœ¨çš„æ–‡ä»¶: ${filename}`);
                        loadNewVideoFile(`video/${filename}`, filename);
                        resolve();
                    }
                };

                testVideo.addEventListener('loadedmetadata', successHandler);
                testVideo.addEventListener('canplay', successHandler);
                testVideo.addEventListener('error', () => {
                    if (!resolved) {
                        resolved = true;
                        clearTimeout(timeoutId);
                        resolve();
                    }
                });

                try {
                    testVideo.src = `video/${filename}`;
                } catch (e) {
                    if (!resolved) {
                        resolved = true;
                        clearTimeout(timeoutId);
                        resolve();
                    }
                }
            });
        }

        // Cé”®åŠŸèƒ½ï¼šæ¸…é™¤å·²åˆ é™¤çš„æ–‡ä»¶å¯¹åº”çš„å®‡å®™æœ‹å‹
        async function cleanupDeletedFiles() {
            console.log('ğŸ§¹ Cé”®è§¦å‘ï¼šå¼€å§‹æ¸…é™¤å·²åˆ é™¤çš„æ–‡ä»¶...');
            showNewVideoNotification('æ­£åœ¨æ£€æŸ¥å¹¶æ¸…é™¤å·²åˆ é™¤çš„æ–‡ä»¶...');
            
            if (creatures.length === 0) {
                console.log('å½“å‰æ²¡æœ‰å®‡å®™æœ‹å‹ï¼Œæ— éœ€æ¸…é™¤');
                showNewVideoNotification('å½“å‰æ²¡æœ‰å®‡å®™æœ‹å‹éœ€è¦æ¸…é™¤');
                return;
            }
            
            const beforeCount = creatures.length;
            console.log(`ğŸ“Š å½“å‰å®‡å®™æœ‹å‹æ•°é‡: ${beforeCount}`);
            
            // è·å–å½“å‰æ‰€æœ‰å·²åŠ è½½çš„æ–‡ä»¶å
            const currentLoadedFiles = new Set();
            creatures.forEach(creature => {
                if (creature.video && creature.video.src) {
                    const filename = creature.video.src.split('/').pop();
                    currentLoadedFiles.add(filename);
                }
            });
            
            console.log('ğŸ“‹ å½“å‰å·²åŠ è½½çš„æ–‡ä»¶:', Array.from(currentLoadedFiles));
            
            // ç›®å½•ç›´è¯»æ¨¡å¼ä¸‹ï¼Œç›´æ¥ç”¨ç›®å½•ç»“æœåˆ¤æ–­å¹¶ç§»é™¤
            if (useFsAccess && dirHandle) {
                await enumerateDirectoryAndLoad(); // å†…éƒ¨åŒ…å«æ¸…ç†é€»è¾‘
                return;
            }

            // é€ä¸ªæ£€æµ‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼ˆé¿å…å¹¶å‘å¹²æ‰°ï¼‰
            console.log('ğŸ” å¼€å§‹é€ä¸ªæ£€æµ‹æ–‡ä»¶å­˜åœ¨æ€§...');
            const deletedFiles = [];
            
            for (const filename of Array.from(currentLoadedFiles)) {
                console.log(`ğŸ” æ­£åœ¨æ£€æµ‹æ–‡ä»¶: ${filename}`);
                const exists = await checkFileExists(filename);
                
                if (!exists) {
                    deletedFiles.push(filename);
                    console.log(`âŒ ç¡®è®¤æ–‡ä»¶å·²åˆ é™¤: ${filename}`);
                } else {
                    console.log(`âœ… ç¡®è®¤æ–‡ä»¶å­˜åœ¨: ${filename}`);
                }
                
                // æ·»åŠ å°å»¶è¿Ÿï¼Œé¿å…æ£€æµ‹å†²çª
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            if (deletedFiles.length === 0) {
                console.log('âœ… æ‰€æœ‰æ–‡ä»¶éƒ½å­˜åœ¨ï¼Œæ— éœ€æ¸…é™¤');
                showNewVideoNotification('æ‰€æœ‰æ–‡ä»¶éƒ½å­˜åœ¨ï¼Œæ— éœ€æ¸…é™¤');
                return;
            }
            
            // ç§»é™¤å·²åˆ é™¤æ–‡ä»¶å¯¹åº”çš„å®‡å®™æœ‹å‹
            console.log(`ğŸ—‘ï¸ å¼€å§‹ç§»é™¤ ${deletedFiles.length} ä¸ªå·²åˆ é™¤æ–‡ä»¶çš„å®‡å®™æœ‹å‹...`);
            removeDeletedCreatures(deletedFiles);
            
            const afterCount = creatures.length;
            const removedCount = beforeCount - afterCount;
            
            console.log(`âœ… æ¸…é™¤å®Œæˆï¼ç§»é™¤äº† ${removedCount} ä¸ªå®‡å®™æœ‹å‹`);
            console.log(`ğŸ“Š æ¸…é™¤åå®‡å®™æœ‹å‹æ•°é‡: ${afterCount}`);
            
            showNewVideoNotification(`ğŸ§¹ æ¸…é™¤å®Œæˆï¼šç§»é™¤äº† ${removedCount} ä¸ªå·²åˆ é™¤æ–‡ä»¶çš„å®‡å®™æœ‹å‹`);
        }

        // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ - ä¿®å¤ç‰ˆæœ¬
        async function checkFileExists(filename) {
            return new Promise((resolve) => {
                const video = document.createElement('video');
                const fullPath = `video/${filename}`;
                
                let resolved = false;
                let hasMetadata = false;
                let hasValidDimensions = false;
                
                // åŠ¨æ€è¶…æ—¶ï¼šfileåè®®æ›´å®½æ¾
                const TIMEOUT_MS = window.location.protocol === 'file:' ? 2000 : 800;
                const timeout = setTimeout(() => {
                    if (!resolved) {
                        resolved = true;
                        console.log(`â° æ–‡ä»¶æ£€æµ‹è¶…æ—¶: ${filename} - åˆ¤å®šä¸ºä¸å­˜åœ¨`);
                        resolve(false); // è¶…æ—¶åˆ¤å®šä¸ºæ–‡ä»¶ä¸å­˜åœ¨
                    }
                }, TIMEOUT_MS);
                
                // åªæœ‰åœ¨çœŸæ­£åŠ è½½åˆ°æœ‰æ•ˆå…ƒæ•°æ®æ—¶æ‰è®¤ä¸ºæ–‡ä»¶å­˜åœ¨
                video.addEventListener('loadedmetadata', () => {
                    if (!resolved) {
                        hasMetadata = true;
                        // æ£€æŸ¥è§†é¢‘å°ºå¯¸ï¼Œç¡®ä¿æ˜¯æœ‰æ•ˆçš„è§†é¢‘æ–‡ä»¶
                        if (video.videoWidth > 0 && video.videoHeight > 0) {
                            hasValidDimensions = true;
                            resolved = true;
                            clearTimeout(timeout);
                            console.log(`âœ… æ–‡ä»¶ç¡®å®å­˜åœ¨: ${filename} (${video.videoWidth}x${video.videoHeight})`);
                            resolve(true);
                        } else {
                            console.log(`âŒ æ–‡ä»¶æ— æ•ˆæˆ–æŸå: ${filename} - å°ºå¯¸ä¸º ${video.videoWidth}x${video.videoHeight}`);
                            resolved = true;
                            clearTimeout(timeout);
                            resolve(false);
                        }
                    }
                });
                
                // åŠ è½½æ•°æ®äº‹ä»¶ - ä½œä¸ºå¤‡ç”¨æ£€æµ‹
                video.addEventListener('loadeddata', () => {
                    if (!resolved && !hasMetadata) {
                        if (video.videoWidth > 0 && video.videoHeight > 0) {
                            resolved = true;
                            clearTimeout(timeout);
                            console.log(`âœ… æ–‡ä»¶å­˜åœ¨(é€šè¿‡loadeddata): ${filename}`);
                            resolve(true);
                        }
                    }
                });
                
                // é”™è¯¯äº‹ä»¶ - æ˜ç¡®è¡¨ç¤ºæ–‡ä»¶ä¸å­˜åœ¨
                video.addEventListener('error', (e) => {
                    if (!resolved) {
                        resolved = true;
                        clearTimeout(timeout);
                        console.log(`âŒ æ–‡ä»¶ç¡®å®ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®: ${filename}`, e.target.error);
                        resolve(false);
                    }
                });
                
                // ä¸­æ­¢äº‹ä»¶ - å¯èƒ½è¡¨ç¤ºæ–‡ä»¶é—®é¢˜
                video.addEventListener('abort', () => {
                    if (!resolved) {
                        resolved = true;
                        clearTimeout(timeout);
                        console.log(`âŒ æ–‡ä»¶åŠ è½½ä¸­æ­¢: ${filename} - å¯èƒ½ä¸å­˜åœ¨`);
                        resolve(false);
                    }
                });
                
                // åœæ­¢äº‹ä»¶ - å¯èƒ½è¡¨ç¤ºæ–‡ä»¶é—®é¢˜
                video.addEventListener('stalled', () => {
                    if (!resolved) {
                        // ç»™æ›´å¤šæ—¶é—´ï¼Œä½†ä¸ç«‹å³åˆ¤å®š
                        setTimeout(() => {
                            if (!resolved && !hasMetadata) {
                                resolved = true;
                                clearTimeout(timeout);
                                console.log(`âŒ æ–‡ä»¶åŠ è½½åœæ»: ${filename} - å¯èƒ½ä¸å­˜åœ¨`);
                                resolve(false);
                            }
                        }, 300);
                    }
                });
                
                // è®¾ç½®è§†é¢‘å±æ€§
                video.preload = 'metadata';
                video.muted = true;
                video.style.display = 'none';
                
                // file://åè®®ä¸‹ä¸è®¾ç½®crossOrigin
                if (window.location.protocol !== 'file:') {
                    video.crossOrigin = 'anonymous';
                }
                
                try {
                    video.src = fullPath;
                    // æ‰‹åŠ¨è§¦å‘åŠ è½½
                    video.load();
                } catch (e) {
                    if (!resolved) {
                        resolved = true;
                        clearTimeout(timeout);
                        console.log(`âŒ è®¾ç½®è§†é¢‘æºå¤±è´¥: ${filename}`, e);
                        resolve(false);
                    }
                }
            });
        }

        // ç§»é™¤å·²åˆ é™¤æ–‡ä»¶å¯¹åº”çš„å®‡å®™æœ‹å‹
        function removeDeletedCreatures(deletedFiles) {
            const deletedFilesSet = new Set(deletedFiles);
            const originalCount = creatures.length;
            
            // ç­›é€‰å‡ºéœ€è¦ä¿ç•™çš„å®‡å®™æœ‹å‹
            const remainingCreatures = creatures.filter(creature => {
                if (creature.video && creature.video.src) {
                    const filename = creature.video.src.split('/').pop();
                    const shouldKeep = !deletedFilesSet.has(filename);
                    
                    if (!shouldKeep) {
                        // é‡Šæ”¾è§†é¢‘èµ„æº
                        if (creature.video.src && creature.video.src.startsWith('blob:')) {
                            URL.revokeObjectURL(creature.video.src);
                        }
                        console.log(`ğŸ—‘ï¸ ç§»é™¤å·²åˆ é™¤æ–‡ä»¶çš„å®‡å®™æœ‹å‹: ${filename}`);
                    }
                    
                    return shouldKeep;
                }
                return true;
            });
            
            // æ›´æ–°å®‡å®™æœ‹å‹åˆ—è¡¨
            creatures.length = 0;
            creatures.push(...remainingCreatures);
            
            // ä»å·²çŸ¥æ–‡ä»¶åˆ—è¡¨ä¸­ç§»é™¤
            deletedFiles.forEach(filename => {
                knownVideoFiles.delete(filename);
                knownVideoFiles.delete(`${filename}_not_found`);
                console.log(`ğŸ—‘ï¸ ä»å·²çŸ¥æ–‡ä»¶åˆ—è¡¨ä¸­ç§»é™¤: ${filename}`);
            });
            
            // æ›´æ–°UI
            updateCreatureCount();
            
            const removedCount = originalCount - creatures.length;
            console.log(`âœ… æˆåŠŸç§»é™¤ ${removedCount} ä¸ªå®‡å®™æœ‹å‹ï¼Œå½“å‰å‰©ä½™ ${creatures.length} ä¸ª`);
        }

        // åœæ­¢è§†é¢‘æ–‡ä»¶å¤¹ç›‘å¬
        function stopVideoMonitoring() {
            if (!isMonitoring) return;
            
            isMonitoring = false;
            if (videoMonitorInterval) {
                clearInterval(videoMonitorInterval);
                videoMonitorInterval = null;
            }
            console.log('å·²åœæ­¢ç›‘å¬videoæ–‡ä»¶å¤¹');
        }

        // åˆ‡æ¢è§†é¢‘æ–‡ä»¶å¤¹ç›‘å¬çŠ¶æ€
        function toggleVideoMonitoring() {
            if (isMonitoring) {
                stopVideoMonitoring();
                updateMonitorStatus();
                showNewVideoNotification('å·²åœæ­¢æ–‡ä»¶å¤¹ç›‘å¬');
            } else {
                startVideoMonitoring();
                updateMonitorStatus();
                showNewVideoNotification(useFsAccess ? 'å·²å¼€å¯ç›®å½•ç›´è¯»ç›‘å¬' : 'å·²å¼€å¯æ–‡ä»¶å¤¹ç›‘å¬');
            }
        }

        // æ›´æ–°ç›‘å¬çŠ¶æ€æ˜¾ç¤º
        function updateMonitorStatus() {
            const statusElement = document.getElementById('monitor-status');
            if (statusElement) {
                statusElement.textContent = isMonitoring ? 'è‡ªåŠ¨ç›‘å¬' : 'æ‰‹åŠ¨æ¨¡å¼';
                statusElement.style.color = isMonitoring ? '#00ff00' : '#ffaa00';
            }
        }

        // æ‰‹åŠ¨åˆ·æ–°videoæ–‡ä»¶å¤¹ - Fé”®è§¦å‘å¿«é€Ÿæ£€æµ‹
        async function manualRefreshVideoFolder() {
            console.log('ğŸ”„ Fé”®è§¦å‘ï¼šå¿«é€Ÿæ£€æµ‹æ–°å¢æ–‡ä»¶...');
            showNewVideoNotification('æ­£åœ¨å¿«é€Ÿæ£€æµ‹æ–°å¢æ–‡ä»¶...');
            
            const beforeCount = creatures.length;
            
            // FS ç›®å½•ç›´è¯»æ¨¡å¼ä¸‹ï¼Œç›´æ¥æšä¸¾ç›®å½•
            if (useFsAccess && dirHandle) {
                await enumerateDirectoryAndLoad();
                const afterCount = creatures.length;
                const newFilesFound = afterCount - beforeCount;
                console.log(`âœ… å¿«é€Ÿæ£€æµ‹å®Œæˆï¼å‘ç° ${newFilesFound} ä¸ªæ–°æ–‡ä»¶ (FS)`);
                if (newFilesFound > 0) {
                    showNewVideoNotification(`ğŸ”„ å¿«é€Ÿæ£€æµ‹ï¼šå‘ç° ${newFilesFound} ä¸ªæ–°æ–‡ä»¶ï¼`);
                } else {
                    showNewVideoNotification('å¿«é€Ÿæ£€æµ‹å®Œæˆï¼šæœªå‘ç°æ–°æ–‡ä»¶');
                }
                return;
            }
            
            // æ¸…é™¤æ£€æµ‹ç¼“å­˜ï¼Œå¼ºåˆ¶é‡æ–°æ£€æµ‹æ‰€æœ‰æ–‡ä»¶
            const currentFiles = new Set();
            creatures.forEach(creature => {
                if (creature.video && creature.video.src) {
                    const filename = creature.video.src.split('/').pop();
                    currentFiles.add(filename);
                }
            });
            
            // æ¸…ç©ºç¼“å­˜å¹¶é‡æ–°è®°å½•å·²åŠ è½½çš„æ–‡ä»¶
            knownVideoFiles.clear();
            currentFiles.forEach(filename => {
                knownVideoFiles.add(filename);
            });
            
            // æ‰§è¡Œå¿«é€Ÿæ‰«æ
            await quickScanNewFiles();
            
            const afterCount = creatures.length;
            const newFilesFound = afterCount - beforeCount;
            
            console.log(`âœ… å¿«é€Ÿæ£€æµ‹å®Œæˆï¼å‘ç° ${newFilesFound} ä¸ªæ–°æ–‡ä»¶`);
            
            if (newFilesFound > 0) {
                showNewVideoNotification(`ğŸ”„ å¿«é€Ÿæ£€æµ‹ï¼šå‘ç° ${newFilesFound} ä¸ªæ–°æ–‡ä»¶ï¼`);
            } else {
                showNewVideoNotification('å¿«é€Ÿæ£€æµ‹å®Œæˆï¼šæœªå‘ç°æ–°æ–‡ä»¶');
            }
        }



        // å°è¯•åŠ è½½æ–°æ–‡ä»¶
        async function tryLoadNewFile(filename) {
            return new Promise((resolve) => {
                // å¦‚æœå·²ç»æ£€æµ‹è¿‡ä¸”æ ‡è®°ä¸ºä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›
                if (knownVideoFiles.has(`${filename}_not_found`)) {
                    resolve(false);
                    return;
                }
                
                // å¦‚æœå·²ç»åœ¨å·²çŸ¥æ–‡ä»¶åˆ—è¡¨ä¸­ï¼Œæ£€æŸ¥æ˜¯å¦çœŸçš„å·²åŠ è½½
                if (knownVideoFiles.has(filename)) {
                    const alreadyLoaded = creatures.some(creature => 
                        creature.video && creature.video.src && creature.video.src.includes(filename)
                    );
                    
                    if (alreadyLoaded) {
                        resolve(false);
                        return;
                    } else {
                        // æ–‡ä»¶åœ¨å·²çŸ¥åˆ—è¡¨ä¸­ä½†æœªåŠ è½½ï¼Œå¯èƒ½æ˜¯ä¹‹å‰æ£€æµ‹åˆ°ä½†æœªæˆåŠŸåŠ è½½
                        console.log(`ğŸ”„ é‡æ–°å°è¯•åŠ è½½å·²çŸ¥æ–‡ä»¶: ${filename}`);
                    }
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨ç”Ÿç‰©åˆ—è¡¨ä¸­
                const alreadyLoaded = creatures.some(creature => 
                    creature.video && creature.video.src && creature.video.src.includes(filename)
                );
                
                if (alreadyLoaded) {
                    // ç¡®ä¿åœ¨å·²çŸ¥æ–‡ä»¶åˆ—è¡¨ä¸­
                    knownVideoFiles.add(filename);
                    resolve(false);
                    return;
                }
                
                const video = document.createElement('video');
                const fullPath = `video/${filename}`;
                
                let resolved = false;
                const TIMEOUT_MS = window.location.protocol === 'file:' ? 2000 : 800;
                const timeout = setTimeout(() => {
                    if (!resolved) {
                        resolved = true;
                        knownVideoFiles.add(`${filename}_not_found`);
                        resolve(false);
                    }
                }, TIMEOUT_MS); // æ ¹æ®åè®®åŠ¨æ€è¶…æ—¶
                
                video.addEventListener('loadstart', () => {
                    if (!resolved) {
                        resolved = true;
                        clearTimeout(timeout);
                        knownVideoFiles.add(filename);
                        console.log(`ğŸ¯ æ£€æµ‹åˆ°æ–°æ–‡ä»¶: ${filename}`);
                        loadNewVideoFile(fullPath, filename);
                        resolve(true);
                    }
                });
                
                video.addEventListener('loadedmetadata', () => {
                    if (!resolved) {
                        resolved = true;
                        clearTimeout(timeout);
                        knownVideoFiles.add(filename);
                        console.log(`âœ… æˆåŠŸåŠ è½½æ–°æ–‡ä»¶: ${filename}`);
                        loadNewVideoFile(fullPath, filename);
                        resolve(true);
                    }
                });
                
                video.addEventListener('error', () => {
                    if (!resolved) {
                        resolved = true;
                        clearTimeout(timeout);
                        knownVideoFiles.add(`${filename}_not_found`);
                        resolve(false);
                    }
                });
                
                // è®¾ç½®è§†é¢‘å±æ€§å¹¶å¼€å§‹åŠ è½½
                video.preload = 'metadata';
                video.muted = true;
                video.style.display = 'none';
                // file://åè®®ä¸‹ä¸è®¾ç½®crossOrigin
                if (window.location.protocol !== 'file:') {
                    video.crossOrigin = 'anonymous';
                }
                
                try {
                    video.src = fullPath;
                } catch (e) {
                    if (!resolved) {
                        resolved = true;
                        clearTimeout(timeout);
                        knownVideoFiles.add(`${filename}_not_found`);
                        resolve(false);
                    }
                }
            });
        }


        // æ›´æ–°æ–‡ä»¶åˆ—è¡¨ - è½»é‡çº§ç‰ˆæœ¬
        function updateFileList() {
            console.log('ğŸš€ Ué”®è§¦å‘ï¼šæ‰©å±•æ£€æµ‹åˆ—è¡¨...');
            showNewVideoNotification('å·²æ‰©å±•æ£€æµ‹èŒƒå›´åˆ°1-999.webm');

            // ç®€å•æ‰©å±•æ•°å­—æ£€æµ‹èŒƒå›´ï¼Œæ— éœ€å¤æ‚é€»è¾‘
            console.log('ğŸ“‹ æ‰©å±•æ•°å­—æ–‡ä»¶æ£€æµ‹èŒƒå›´åˆ°1-999');
            
            // ç«‹å³è¿›è¡Œä¸€æ¬¡å¿«é€Ÿæ‰«æ
            quickScanNewFiles();
        }

        // æ˜¾ç¤ºæ‰‹åŠ¨æ·»åŠ æ–‡ä»¶é¢æ¿
        function showManualAddPanel() {
            const panel = document.getElementById('manual-add-panel');
            if (panel) {
                panel.style.display = 'block';
                const input = document.getElementById('manual-filename');
                if (input) {
                    input.focus();
                }
            }
        }

        // éšè—æ‰‹åŠ¨æ·»åŠ æ–‡ä»¶é¢æ¿
        function hideManualAddPanel() {
            const panel = document.getElementById('manual-add-panel');
            if (panel) {
                panel.style.display = 'none';
                const input = document.getElementById('manual-filename');
                if (input) {
                    input.value = '';
                }
            }
        }

        // æ‰‹åŠ¨åŠ è½½æŒ‡å®šæ–‡ä»¶
        async function loadManualFile() {
            const input = document.getElementById('manual-filename');
            if (!input || !input.value.trim()) {
                alert('è¯·è¾“å…¥æ–‡ä»¶å');
                return;
            }

            const filename = input.value.trim();
            console.log(`å°è¯•æ‰‹åŠ¨åŠ è½½æ–‡ä»¶: ${filename}`);
            
            // æ£€æŸ¥æ–‡ä»¶åæ˜¯å¦åŒ…å«.webmæ‰©å±•å
            if (!filename.toLowerCase().endsWith('.webm')) {
                alert('æ–‡ä»¶åå¿…é¡»ä»¥.webmç»“å°¾');
                return;
            }

            // ä»å·²çŸ¥æ–‡ä»¶åˆ—è¡¨ä¸­ç§»é™¤ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œå¼ºåˆ¶é‡æ–°æ£€æŸ¥
            knownVideoFiles.delete(filename);
            knownVideoFiles.delete(`${filename}_not_found`);

            showNewVideoNotification(`æ­£åœ¨åŠ è½½: ${filename}`);
            hideManualAddPanel();

            // æ‰‹åŠ¨åŠ è½½æ—¶æ ¹æ®åè®®é€‰æ‹©ä¸åŒç­–ç•¥
            const fullPath = `video/${filename}`;
            const isFileProtocol = window.location.protocol === 'file:';
            
            if (isFileProtocol) {
                // FILEåè®®ä¸‹çš„æ‰‹åŠ¨åŠ è½½
                manualLoadForFileProtocol(fullPath, filename);
            } else {
                // HTTPåè®®ä¸‹çš„æ‰‹åŠ¨åŠ è½½
                manualLoadForHttpProtocol(fullPath, filename);
            }
        }

        // FILEåè®®ä¸‹çš„æ‰‹åŠ¨åŠ è½½
        function manualLoadForFileProtocol(fullPath, filename) {
            const video = document.createElement('video');
            video.src = fullPath;
            video.loop = true;
            video.muted = true;
            video.autoplay = false; // FILEåè®®ä¸‹ä¸è‡ªåŠ¨æ’­æ”¾
            video.preload = 'metadata';
            // ä¸è®¾ç½®crossOriginï¼Œé¿å…CORSé—®é¢˜
            video.playsInline = true;

            let handled = false;
            const onSuccess = () => {
                if (handled) return;
                if (video.videoWidth === 0 || video.videoHeight === 0) {
                    console.error(`[FILEåè®®] æ‰‹åŠ¨åŠ è½½-æ— æ•ˆè§†é¢‘å°ºå¯¸: ${filename}`);
                    showNewVideoNotification('è§†é¢‘æ–‡ä»¶æ— æ•ˆæˆ–æŸå');
                    return;
                }
                handled = true;
                setTimeout(() => { video.play().catch(() => {}); }, 100);
                const creature = new Creature(video);
                creatures.push(creature);
                updateCreatureCount();
                loadedFilenames.add(filename);
                knownVideoFiles.add(filename);
                userAddedFiles.add(filename);
                showNewVideoNotification(`æ‰‹åŠ¨åŠ è½½æˆåŠŸ: ${filename}`);
                attachPlaybackGuards(video);
            };
            video.addEventListener('loadedmetadata', onSuccess);
            video.addEventListener('canplay', onSuccess);
            video.addEventListener('loadeddata', onSuccess);

            video.addEventListener('error', (e) => {
                console.error(`âœ— [FILEåè®®] æ‰‹åŠ¨åŠ è½½å¤±è´¥: ${filename}`, e.target.error);
                // åªåœ¨æ‰‹åŠ¨åŠ è½½æ—¶æ˜¾ç¤ºå¤±è´¥é€šçŸ¥ï¼Œå› ä¸ºç”¨æˆ·ä¸»åŠ¨å°è¯•åŠ è½½
                showNewVideoNotification(`æ‰‹åŠ¨åŠ è½½å¤±è´¥: ${filename} - è¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨`);
            });
        }

        // HTTPåè®®ä¸‹çš„æ‰‹åŠ¨åŠ è½½
        function manualLoadForHttpProtocol(fullPath, filename) {
            const video = document.createElement('video');
            video.src = fullPath;
            video.loop = true;
            video.muted = true;
            video.autoplay = true;
            video.preload = 'auto';
            video.crossOrigin = 'anonymous';
            video.playsInline = true;
            let handled = false;
            const onSuccess = () => {
                if (handled) return;
                if (video.videoWidth === 0 || video.videoHeight === 0) {
                    console.error(`[HTTPåè®®] æ‰‹åŠ¨åŠ è½½-æ— æ•ˆè§†é¢‘å°ºå¯¸: ${filename}`);
                    showNewVideoNotification('è§†é¢‘æ–‡ä»¶æ— æ•ˆæˆ–æŸå');
                    return;
                }
                handled = true;
                video.play().catch(() => {});
                const creature = new Creature(video);
                creatures.push(creature);
                updateCreatureCount();
                loadedFilenames.add(filename);
                console.log(`âœ“ [HTTPåè®®] æ‰‹åŠ¨åŠ è½½æˆåŠŸ: ${filename} (${video.videoWidth}x${video.videoHeight})`);
                showNewVideoNotification(`æ‰‹åŠ¨åŠ è½½æˆåŠŸ: ${filename}`);
                knownVideoFiles.add(filename);
                userAddedFiles.add(filename);
                attachPlaybackGuards(video);
            };
            video.addEventListener('loadedmetadata', onSuccess);
            video.addEventListener('canplay', onSuccess);
            video.addEventListener('loadeddata', onSuccess);

            video.addEventListener('error', (e) => {
                console.error(`âœ— [HTTPåè®®] æ‰‹åŠ¨åŠ è½½å¤±è´¥: ${filename}`, e);
                // åªåœ¨æ‰‹åŠ¨åŠ è½½æ—¶æ˜¾ç¤ºå¤±è´¥é€šçŸ¥ï¼Œå› ä¸ºç”¨æˆ·ä¸»åŠ¨å°è¯•åŠ è½½
                showNewVideoNotification(`æ‰‹åŠ¨åŠ è½½å¤±è´¥: ${filename} - è¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨`);
            });
        }


        // æ£€æŸ¥å•ä¸ªè§†é¢‘æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”æœªåŠ è½½ - è½»é‡çº§ç‰ˆæœ¬
        async function checkVideoFile(filename) {
            const fullPath = `video/${filename}`;
            
            // å¦‚æœå·²ç»çŸ¥é“è¿™ä¸ªæ–‡ä»¶æˆ–å·²æ ‡è®°ä¸ºä¸å­˜åœ¨ï¼Œè·³è¿‡
            if (knownVideoFiles.has(filename) || knownVideoFiles.has(`${filename}_not_found`)) {
                return;
            }

            return new Promise((resolve) => {
                const testVideo = document.createElement('video');
                testVideo.preload = 'metadata';
                testVideo.muted = true;
                testVideo.style.display = 'none';
                
                // æ ¹æ®åè®®è®¾ç½®crossOrigin
                if (window.location.protocol !== 'file:') {
                    testVideo.crossOrigin = 'anonymous';
                }
                
                let resolved = false;
                
                // è¾ƒçŸ­çš„è¶…æ—¶æ—¶é—´ï¼Œæé«˜æ£€æµ‹é€Ÿåº¦
                const timeoutId = setTimeout(() => {
                    if (!resolved) {
                        resolved = true;
                        knownVideoFiles.add(`${filename}_not_found`);
                        resolve();
                    }
                }, 800);

                // ç»Ÿä¸€çš„æˆåŠŸå¤„ç†
                const successHandler = () => {
                    if (!resolved) {
                        resolved = true;
                        clearTimeout(timeoutId);
                        
                        knownVideoFiles.add(filename);
                        console.log(`âœ… å‘ç°æ–°æ–‡ä»¶: ${filename}`);
                        loadNewVideoFile(fullPath, filename);
                        resolve();
                    }
                };

                // ç›‘å¬å…³é”®äº‹ä»¶
                testVideo.addEventListener('loadedmetadata', successHandler);
                testVideo.addEventListener('canplay', successHandler);

                // é™é»˜å¤„ç†é”™è¯¯
                testVideo.addEventListener('error', () => {
                    if (!resolved) {
                        resolved = true;
                        clearTimeout(timeoutId);
                        knownVideoFiles.add(`${filename}_not_found`);
                        resolve();
                    }
                });

                try {
                    testVideo.src = fullPath;
                } catch (e) {
                    if (!resolved) {
                        resolved = true;
                        clearTimeout(timeoutId);
                        knownVideoFiles.add(`${filename}_not_found`);
                        resolve();
                    }
                }
            });
        }

        // åŠ è½½æ–°å‘ç°çš„è§†é¢‘æ–‡ä»¶
        function loadNewVideoFile(videoPath, filename) {
            // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ç›¸åŒè·¯å¾„çš„è§†é¢‘åœ¨æ’­æ”¾ï¼ˆé¿å…é‡å¤ï¼‰
            const existingCreature = creatures.find(creature => 
                creature.video.src && creature.video.src.includes(filename)
            );
            
            if (existingCreature) {
                console.log(`è§†é¢‘ ${filename} å·²å­˜åœ¨ï¼Œè·³è¿‡åŠ è½½`);
                return;
            }

            // ç»Ÿä¸€åŸºäºæ–‡ä»¶åçš„å»é‡
            if (loadedFilenames.has(filename) || loadingFilenames.has(filename)) {
                console.log(`æ–‡ä»¶å ${filename} å·²åŠ è½½ï¼Œè·³è¿‡`);
                return;
            }
            loadingFilenames.add(filename);

            // æ£€æŸ¥æ•°é‡é™åˆ¶
            const maxFiles = 100;
            if (creatures.length >= maxFiles) {
                console.warn(`å·²è¾¾åˆ°æœ€å¤§ç”Ÿç‰©æ•°é‡é™åˆ¶ (${maxFiles})ï¼Œè·³è¿‡åŠ è½½æ–°è§†é¢‘: ${filename}`);
                loadingFilenames.delete(filename);
                return;
            }

            // æ£€æµ‹åè®®å¹¶é‡‡ç”¨ä¸åŒçš„åŠ è½½ç­–ç•¥
            const isFileProtocol = window.location.protocol === 'file:';
            
            if (isFileProtocol) {
                // FILEåè®®ä¸‹ï¼Œä¸è®¾ç½®crossOriginå±æ€§ï¼Œé¿å…CORSé—®é¢˜
                loadVideoForFileProtocol(videoPath, filename);
            } else {
                // HTTPåè®®ä¸‹ï¼Œä½¿ç”¨æ ‡å‡†åŠ è½½æ–¹å¼
                loadVideoForHttpProtocol(videoPath, filename);
            }
        }

        // FILEåè®®ä¸‹çš„è§†é¢‘åŠ è½½
        function loadVideoForFileProtocol(videoPath, filename) {
            console.log(`[FILEåè®®] å¼€å§‹åŠ è½½è§†é¢‘: ${filename}, è·¯å¾„: ${videoPath}`);
            
            const video = document.createElement('video');
            video.src = videoPath;
            video.loop = true;
            video.muted = true;
            video.autoplay = false; // FILEåè®®ä¸‹å…ˆä¸è‡ªåŠ¨æ’­æ”¾
            video.preload = 'auto'; // æ”¹ä¸ºautoç¡®ä¿å®Œå…¨åŠ è½½
            // ä¸è®¾ç½®crossOriginå±æ€§ï¼Œé¿å…CORSé—®é¢˜
            video.playsInline = true;

            let loadSuccess = false;

            // æ·»åŠ æ›´å¤šäº‹ä»¶ç›‘å¬ä»¥ç¡®ä¿æ•è·æˆåŠŸåŠ è½½
            video.addEventListener('loadstart', () => {
                console.log(`[FILEåè®®] å¼€å§‹åŠ è½½è§†é¢‘æ•°æ®: ${filename}`);
            });

            video.addEventListener('loadeddata', () => {
                if (loadSuccess) return;
                console.log(`[FILEåè®®] è§†é¢‘æ•°æ®åŠ è½½å®Œæˆ: ${filename}`);
                
                // æ£€æŸ¥è§†é¢‘å°ºå¯¸
                if (video.videoWidth === 0 || video.videoHeight === 0) {
                    console.error(`[FILEåè®®] æ— æ•ˆçš„è§†é¢‘å°ºå¯¸: ${filename}`);
                    return;
                }

                loadSuccess = true;
                console.log(`âœ“ [FILEåè®®] æˆåŠŸåŠ è½½è§†é¢‘æ•°æ®: ${filename} (${video.videoWidth}x${video.videoHeight})`);

                // ç«‹å³åˆ›å»ºç”Ÿç‰©å¯¹è±¡
                const creature = new Creature(video);
                creatures.push(creature);
                updateCreatureCount();
                loadedFilenames.add(filename);
                loadingFilenames.delete(filename);
                attachPlaybackGuards(video);
                
                console.log(`âœ“ [FILEåè®®] æˆåŠŸåˆ›å»ºæµ·æ´‹ç”Ÿç‰©: ${filename}, å½“å‰ç”Ÿç‰©æ•°é‡: ${creatures.length}`);
                showNewVideoNotification(`æˆåŠŸåŠ è½½: ${filename}`);

                // å»¶è¿Ÿå°è¯•æ’­æ”¾
                setTimeout(() => {
                    video.play().then(() => {
                        console.log(`âœ“ [FILEåè®®] è§†é¢‘å¼€å§‹æ’­æ”¾: ${filename}`);
                    }).catch(e => {
                        console.log(`[FILEåè®®] è§†é¢‘éœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½æ’­æ”¾: ${filename}`);
                        // è¿™æ˜¯æ­£å¸¸çš„ï¼Œç”¨æˆ·ç‚¹å‡»ç”»å¸ƒæ—¶ä¼šè§¦å‘æ’­æ”¾
                    });
                }, 200);
            });

            video.addEventListener('loadedmetadata', () => {
                if (loadSuccess) return;
                console.log(`[FILEåè®®] è§†é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆ: ${filename}`);
                
                // æ£€æŸ¥è§†é¢‘å°ºå¯¸
                if (video.videoWidth === 0 || video.videoHeight === 0) {
                    console.error(`[FILEåè®®] æ— æ•ˆçš„è§†é¢‘å°ºå¯¸: ${filename}`);
                    return;
                }

                loadSuccess = true;
                console.log(`âœ“ [FILEåè®®] æˆåŠŸåŠ è½½è§†é¢‘å…ƒæ•°æ®: ${filename} (${video.videoWidth}x${video.videoHeight})`);

                // ç«‹å³åˆ›å»ºç”Ÿç‰©å¯¹è±¡
                const creature = new Creature(video);
                creatures.push(creature);
                updateCreatureCount();
                loadedFilenames.add(filename);
                loadingFilenames.delete(filename);
                attachPlaybackGuards(video);
                
                console.log(`âœ“ [FILEåè®®] æˆåŠŸåˆ›å»ºæµ·æ´‹ç”Ÿç‰©: ${filename}, å½“å‰ç”Ÿç‰©æ•°é‡: ${creatures.length}`);
                showNewVideoNotification(`æˆåŠŸåŠ è½½: ${filename}`);

                // å»¶è¿Ÿå°è¯•æ’­æ”¾
                setTimeout(() => {
                    video.play().then(() => {
                        console.log(`âœ“ [FILEåè®®] è§†é¢‘å¼€å§‹æ’­æ”¾: ${filename}`);
                    }).catch(e => {
                        console.log(`[FILEåè®®] è§†é¢‘éœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½æ’­æ”¾: ${filename}`);
                    });
                }, 200);
            });

            video.addEventListener('canplay', () => {
                console.log(`[FILEåè®®] è§†é¢‘å¯ä»¥æ’­æ”¾: ${filename}`);
                if (!loadSuccess) {
                    loadSuccess = true;
                    
                    const creature = new Creature(video);
                    creatures.push(creature);
                    updateCreatureCount();
                    loadedFilenames.add(filename);
                    loadingFilenames.delete(filename);
                    
                    console.log(`âœ“ [FILEåè®®] é€šè¿‡canplayåˆ›å»ºæµ·æ´‹ç”Ÿç‰©: ${filename}, å½“å‰ç”Ÿç‰©æ•°é‡: ${creatures.length}`);
                    showNewVideoNotification(`æˆåŠŸåŠ è½½: ${filename}`);
                }
            });

            video.addEventListener('error', (e) => {
                console.error(`âœ— [FILEåè®®] è§†é¢‘åŠ è½½å¤±è´¥: ${filename}`, e.target.error);
                // éšè—åŠ è½½å¤±è´¥çš„é€šçŸ¥ï¼Œé¿å…å¹²æ‰°ç”¨æˆ·
                // showNewVideoNotification(`åŠ è½½å¤±è´¥: ${filename}`);
                loadingFilenames.delete(filename);
            });

            // æ·»åŠ è°ƒè¯•ä¿¡æ¯
            console.log(`[FILEåè®®] è§†é¢‘å…ƒç´ åˆ›å»ºå®Œæˆï¼Œç­‰å¾…åŠ è½½äº‹ä»¶: ${filename}`);
        }

        // HTTPåè®®ä¸‹çš„è§†é¢‘åŠ è½½
        function loadVideoForHttpProtocol(videoPath, filename) {
            const video = document.createElement('video');
            video.src = videoPath;
            video.loop = true;
            video.muted = true;
            video.autoplay = true;
            video.preload = 'auto';
            video.crossOrigin = 'anonymous';
            video.playsInline = true;

            let handled = false;
            const onSuccess = () => {
                if (handled) return;
                if (video.videoWidth === 0 || video.videoHeight === 0) {
                    console.error(`[HTTPåè®®] æ— æ•ˆçš„è§†é¢‘å°ºå¯¸: ${filename}`);
                    loadingFilenames.delete(filename);
                    return;
                }
                handled = true;
                video.play().catch(() => {});
                const creature = new Creature(video);
                creatures.push(creature);
                updateCreatureCount();
                loadedFilenames.add(filename);
                loadingFilenames.delete(filename);
                attachPlaybackGuards(video);
                console.log(`âœ“ [HTTPåè®®] æˆåŠŸåˆ›å»ºæµ·æ´‹ç”Ÿç‰©: ${filename} (${video.videoWidth}x${video.videoHeight})`);
                showNewVideoNotification(`æˆåŠŸåŠ è½½: ${filename}`);
            };
            video.addEventListener('loadedmetadata', onSuccess);
            video.addEventListener('canplay', onSuccess);
            video.addEventListener('loadeddata', onSuccess);

            video.addEventListener('error', (e) => {
                if (handled) return;
                handled = true;
                console.error(`âœ— [HTTPåè®®] è§†é¢‘åŠ è½½å¤±è´¥: ${filename}`, e);
                loadingFilenames.delete(filename);
            });
        }

        // è°ƒè¯•ç”Ÿç‰©çŠ¶æ€
        function debugCreatures() {
            console.log('=== ç”Ÿç‰©è°ƒè¯•ä¿¡æ¯ ===');
            console.log(`æ€»ç”Ÿç‰©æ•°é‡: ${creatures.length}`);
            console.log(`å·²çŸ¥æ–‡ä»¶æ•°é‡: ${knownVideoFiles.size}`);
            
            creatures.forEach((creature, index) => {
                const video = creature.video;
                console.log(`ç”Ÿç‰© ${index + 1}:`, {
                    src: video.src,
                    readyState: video.readyState,
                    paused: video.paused,
                    ended: video.ended,
                    width: video.videoWidth,
                    height: video.videoHeight,
                    position: `(${Math.round(creature.x)}, ${Math.round(creature.y)})`,
                    size: `${Math.round(creature.width)}x${Math.round(creature.height)}`
                });
            });
            
            console.log('å·²çŸ¥æ–‡ä»¶åˆ—è¡¨:', Array.from(knownVideoFiles));
            console.log('ç”¨æˆ·æ·»åŠ æ–‡ä»¶:', Array.from(userAddedFiles));
        }

        // æµ‹è¯•æ£€æµ‹åŠŸèƒ½
        async function testDetection() {
            console.log('ğŸ§ª å¼€å§‹æµ‹è¯•æ£€æµ‹åŠŸèƒ½...');
            showNewVideoNotification('æ­£åœ¨æµ‹è¯•æ£€æµ‹å½“å‰æ–‡ä»¶å¤¹ä¸­çš„å·²çŸ¥æ–‡ä»¶...');
            
            // æµ‹è¯•å½“å‰æ–‡ä»¶å¤¹ä¸­ç¡®å®å­˜åœ¨çš„æ–‡ä»¶
            const testFiles = [
                '1.webm', '2.webm', '3.webm', '4.webm',
                'Character_00002_transparent.webm', 'Character_00004_transparent.webm',
                'Character_00005_transparent.webm', 'Character_00006_transparent.webm',
                'Character_00007_transparent.webm', 'Character_00008_transparent.webm'
            ];
            
            console.log('ğŸ¯ æµ‹è¯•æ–‡ä»¶åˆ—è¡¨:', testFiles);
            
            for (const filename of testFiles) {
                console.log(`ğŸ” æµ‹è¯•æ£€æµ‹: ${filename}`);
                
                // æ¸…é™¤ä¹‹å‰çš„è®°å½•ï¼Œå¼ºåˆ¶é‡æ–°æ£€æµ‹
                knownVideoFiles.delete(filename);
                knownVideoFiles.delete(`${filename}_not_found`);
                
                try {
                    const result = await tryLoadNewFile(filename);
                    
                    if (result) {
                        console.log(`âœ… æµ‹è¯•æˆåŠŸ: ${filename} - æ–‡ä»¶å­˜åœ¨ä¸”å·²åŠ è½½`);
                    } else if (knownVideoFiles.has(`${filename}_not_found`)) {
                        console.log(`âŒ æµ‹è¯•å¤±è´¥: ${filename} - æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æ³•åŠ è½½`);
                    } else {
                        console.log(`âš ï¸ æµ‹è¯•è·³è¿‡: ${filename} - æ–‡ä»¶å·²å­˜åœ¨`);
                    }
                } catch (error) {
                    console.error(`ğŸ’¥ æµ‹è¯•é”™è¯¯: ${filename}`, error);
                }
                
                // å»¶è¿Ÿï¼Œé¿å…è¿‡å¿«
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
            const validFiles = Array.from(knownVideoFiles).filter(f => !f.endsWith('_not_found'));
            console.log(`ğŸ¯ æµ‹è¯•å®Œæˆï¼å½“å‰æœ‰æ•ˆæ–‡ä»¶: ${validFiles.length} ä¸ª`);
            console.log('ğŸ“‹ æœ‰æ•ˆæ–‡ä»¶åˆ—è¡¨:', validFiles);
            
            showNewVideoNotification(`æµ‹è¯•å®Œæˆï¼šå‘ç° ${validFiles.length} ä¸ªæœ‰æ•ˆæ–‡ä»¶`);
        }

        // å¼ºåˆ¶å…¨é¢æ‰«æ
        async function forceFullScan() {
            console.log('ğŸ’ª Sé”®è§¦å‘ï¼šå¼ºåˆ¶å…¨é¢æ‰«ææ‰€æœ‰å¯èƒ½çš„æ–‡ä»¶...');
            showNewVideoNotification('æ­£åœ¨æ‰§è¡Œå¼ºåˆ¶å…¨é¢æ‰«æ...');
            
            // è®°å½•æ£€æµ‹å‰çš„çŠ¶æ€
            const beforeCount = creatures.length;
            console.log(`ğŸ¯ å½“å‰å·²åŠ è½½æ–‡ä»¶æ•°é‡: ${beforeCount}`);
            
            // å®Œå…¨æ¸…ç©ºæ£€æµ‹ç¼“å­˜
            console.log('ğŸ—‘ï¸ å®Œå…¨æ¸…ç©ºæ£€æµ‹ç¼“å­˜...');
            knownVideoFiles.clear();
            
            // é‡æ–°è®°å½•å·²åŠ è½½çš„æ–‡ä»¶
            const loadedFiles = new Set();
            creatures.forEach(creature => {
                if (creature.video && creature.video.src) {
                    const filename = creature.video.src.split('/').pop();
                    loadedFiles.add(filename);
                    knownVideoFiles.add(filename);
                }
            });
            
            console.log('ğŸ“‹ å·²åŠ è½½çš„æ–‡ä»¶:', Array.from(loadedFiles));
            
            // æ‰§è¡Œæœ€å…¨é¢çš„æ‰«æ
            await performComprehensiveScan();
            
            // ç»Ÿè®¡ç»“æœ
            const afterCount = creatures.length;
            const newFilesFound = afterCount - beforeCount;
            
            console.log(`ğŸ’ª å¼ºåˆ¶å…¨é¢æ‰«æå®Œæˆï¼æ–°å‘ç° ${newFilesFound} ä¸ªè§†é¢‘æ–‡ä»¶`);
            console.log(`ğŸ“Š æ€»æ–‡ä»¶æ•°é‡: ${beforeCount} â†’ ${afterCount}`);
            
            if (newFilesFound > 0) {
                showNewVideoNotification(`ğŸ’ª å¼ºåˆ¶æ‰«ææˆåŠŸï¼šå‘ç° ${newFilesFound} ä¸ªæ–°æ–‡ä»¶ï¼`);
            } else {
                showNewVideoNotification('å¼ºåˆ¶æ‰«æå®Œæˆï¼šæœªå‘ç°æ–°æ–‡ä»¶');
            }
        }

        // æ˜¾ç¤ºæ–°è§†é¢‘é€šçŸ¥
        function showNewVideoNotification(filename) {
            // åˆ›å»ºä¸´æ—¶é€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: rgba(0, 150, 255, 0.9);
                color: white;
                padding: 10px 15px;
                border-radius: 5px;
                font-size: 14px;
                z-index: 200;
                animation: slideIn 0.3s ease-out;
            `;
            notification.textContent = `å‘ç°æ–°æµ·æ´‹ç”Ÿç‰©: ${filename}`;
            
            // æ·»åŠ åŠ¨ç”»æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(notification);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤é€šçŸ¥
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                    if (style.parentNode) {
                        style.parentNode.removeChild(style);
                    }
                }, 300);
            }, 3000);
        }

        // æ£€æµ‹åè®®å¹¶ç»™å‡ºç›¸åº”æç¤º
        function checkProtocolAndNotify() {
            const isFileProtocol = window.location.protocol === 'file:';
            
            if (isFileProtocol) {
                console.log('ğŸ® æ£€æµ‹åˆ°FILEåè®®ï¼Œå¯ç”¨è½»é‡çº§æ£€æµ‹æ¨¡å¼');
                showNewVideoNotification(`ğŸš€ ${useFsAccess ? 'ç›®å½•ç›´è¯»ç›‘å¬' : 'è‡ªåŠ¨ç›‘å¬'}ï¼šæ¯${Math.round(monitorIntervalMs/1000)}ç§’æ‰«æï¼ŒFé”®ç«‹å³æ£€æµ‹ï¼Œå¯åœ¨å¸®åŠ©é¢æ¿è®¾ç½®é—´éš”`);
            } else {
                console.log('ğŸŒ æ£€æµ‹åˆ°HTTPåè®®ï¼Œå¯ç”¨è½»é‡çº§æ£€æµ‹æ¨¡å¼');
                showNewVideoNotification(`ğŸš€ ${useFsAccess ? 'ç›®å½•ç›´è¯»ç›‘å¬' : 'è‡ªåŠ¨ç›‘å¬'}ï¼šæ¯${Math.round(monitorIntervalMs/1000)}ç§’æ‰«æï¼ŒFé”®ç«‹å³æ£€æµ‹ï¼Œå¯åœ¨å¸®åŠ©é¢æ¿è®¾ç½®é—´éš”`);
            }
        }

        // æ›´æ–°FPSæ˜¾ç¤º
        function updateFPS(currentTime) {
            frameCount++;
            
            if (currentTime - lastFpsUpdate >= 1000) { // æ¯ç§’æ›´æ–°ä¸€æ¬¡
                const fps = Math.round(frameCount * 1000 / (currentTime - lastFpsUpdate));
                document.getElementById('fps-counter').textContent = fps;
                
                // æ€§èƒ½ç›‘æ§ï¼šå¦‚æœFPSè¿‡ä½ä¸”ç”Ÿç‰©æ•°é‡è¾ƒå¤šï¼Œæ˜¾ç¤ºè­¦å‘Š
                if (fps < 30 && creatures.length > 20) {
                    showPerformanceWarning();
                }
                
                frameCount = 0;
                lastFpsUpdate = currentTime;
            }
        }

        // æ˜¾ç¤ºæ€§èƒ½è­¦å‘Š
        let performanceWarningShown = false;
        function showPerformanceWarning() {
            if (!SHOW_PERFORMANCE_WARNING) return;
            if (performanceWarningShown) return;
            
            const warning = document.getElementById('performance-warning');
            if (!warning) return;
            warning.style.display = 'block';
            performanceWarningShown = true;
            
            // 5ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                warning.style.display = 'none';
                // 10åˆ†é’Ÿåå…è®¸å†æ¬¡æ˜¾ç¤ºè­¦å‘Š
                setTimeout(() => {
                    performanceWarningShown = false;
                }, 600000);
            }, 5000);
        }

        // åŠ¨ç”»å¾ªç¯
        function animate(currentTime = 0) {
            // æ›´æ–°å…¨å±€æ—¶é—´ï¼ˆç§’ï¼‰ä¾›æ­£å¼¦LFOä½¿ç”¨
            globalTime = currentTime / 1000;
            // æ€§èƒ½ä¼˜åŒ–ï¼šåªæœ‰å½“æœ‰ç”Ÿç‰©æ—¶æ‰æ¸…ç©ºå’Œé‡ç»˜ç”»å¸ƒ
            if (creatures.length > 0) {
                // æ¸…ç©ºç”»å¸ƒ
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // æ›´æ–°å’Œç»˜åˆ¶æ‰€æœ‰ç”Ÿç‰©
                for (let i = creatures.length - 1; i >= 0; i--) {
                    const creature = creatures[i];
                    
                    // æ£€æŸ¥è§†é¢‘æ˜¯å¦ä»ç„¶æœ‰æ•ˆ
                    if (creature.video.error || creature.video.ended) {
                        // ç§»é™¤æ— æ•ˆçš„ç”Ÿç‰©
                        creatures.splice(i, 1);
                        updateCreatureCount();
                        continue;
                    }
                    
                    creature.update();
                    creature.draw();
                }
            }

            // æ›´æ–°FPS
            updateFPS(currentTime);

            // ç»§ç»­åŠ¨ç”»å¾ªç¯
            animationId = requestAnimationFrame(animate);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);

        // é¡µé¢å®Œå…¨åŠ è½½åï¼Œç›‘å¬ç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†videoæ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶
        // ç§»é™¤åŸæœ‰çš„é¢„è®¾è§†é¢‘åŠ è½½é€»è¾‘ï¼Œæ”¹ç”±ç›‘å¬ç³»ç»Ÿç»Ÿä¸€å¤„ç†

        // ===== ç›‘å¬é—´éš”ï¼šæœ¬åœ°å­˜å‚¨ä¸UIäº¤äº’ =====
        function loadMonitorIntervalFromStorage() {
            try {
                const saved = localStorage.getItem(MONITOR_INTERVAL_STORAGE_KEY);
                const seconds = parseInt(saved || '3', 10);
                if (Number.isFinite(seconds) && seconds >= 1 && seconds <= 60) {
                    monitorIntervalMs = seconds * 1000;
                } else {
                    monitorIntervalMs = 3000;
                }
            } catch (e) {
                monitorIntervalMs = 3000;
            }

            // åŒæ­¥åˆ°å¸®åŠ©é¢æ¿UI
            const input = document.getElementById('monitor-interval-input');
            const label = document.getElementById('current-interval-text');
            if (input) input.value = String(Math.round(monitorIntervalMs / 1000));
            if (label) label.textContent = `å½“å‰: ${Math.round(monitorIntervalMs/1000)}s`;
        }

        function setupMonitorControlsUI() {
            const input = document.getElementById('monitor-interval-input');
            const btn = document.getElementById('apply-interval-btn');
            if (!input || !btn) return;

            const apply = () => {
                const seconds = parseInt(input.value, 10);
                let clamped = isNaN(seconds) ? 3 : Math.max(1, Math.min(60, seconds));
                input.value = String(clamped);
                applyMonitorIntervalSeconds(clamped);
            };

            btn.addEventListener('click', apply);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') apply();
            });
        }

        function applyMonitorIntervalSeconds(seconds) {
            monitorIntervalMs = seconds * 1000;
            try {
                localStorage.setItem(MONITOR_INTERVAL_STORAGE_KEY, String(seconds));
            } catch (e) {}

            // æ›´æ–°å¸®åŠ©é¢æ¿æ˜¾ç¤º
            const label = document.getElementById('current-interval-text');
            if (label) label.textContent = `å½“å‰: ${seconds}s`;

            // è‹¥æ­£åœ¨ç›‘å¬åˆ™é‡å¯ç›‘å¬å®šæ—¶å™¨
            if (isMonitoring) {
                if (videoMonitorInterval) clearInterval(videoMonitorInterval);
                videoMonitorInterval = setInterval(() => {
                    quickScanNewFiles();
                }, monitorIntervalMs);
                console.log(`ğŸ” å·²åº”ç”¨æ–°çš„ç›‘å¬é—´éš”: ${monitorIntervalMs}ms`);
                showNewVideoNotification(`ç›‘å¬é—´éš”å·²æ›´æ–°ä¸º ${seconds}s`);
            }
            updateMonitorStatus();
        }

        // ===== é¡µé¢è§†é¢‘ä¸Šé™ï¼šæœ¬åœ°å­˜å‚¨ä¸UIäº¤äº’ =====
        function loadCreatureLimitFromStorage() {
            try {
                const saved = localStorage.getItem(CREATURE_LIMIT_STORAGE_KEY);
                const limit = parseInt(saved || '50', 10);
                if (Number.isFinite(limit) && limit >= 1 && limit <= 100) {
                    creatureLimit = limit;
                } else {
                    creatureLimit = 50;
                }
            } catch (e) {
                creatureLimit = 50;
            }

            // åŒæ­¥åˆ°å¸®åŠ©é¢æ¿UI
            const input = document.getElementById('creature-limit-input');
            const label = document.getElementById('current-limit-text');
            if (input) input.value = String(creatureLimit);
            if (label) label.textContent = `å½“å‰: ${creatureLimit}`;
        }

        function setupLimitControlsUI() {
            const input = document.getElementById('creature-limit-input');
            const btn = document.getElementById('apply-limit-btn');
            if (!input || !btn) return;

            const apply = () => {
                const limit = parseInt(input.value, 10);
                let clamped = isNaN(limit) ? 50 : Math.max(1, Math.min(100, limit));
                input.value = String(clamped);
                applyCreatureLimit(clamped);
            };

            btn.addEventListener('click', apply);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') apply();
            });
        }

        function applyCreatureLimit(limit) {
            creatureLimit = limit;
            try {
                localStorage.setItem(CREATURE_LIMIT_STORAGE_KEY, String(limit));
            } catch (e) {}

            const label = document.getElementById('current-limit-text');
            if (label) label.textContent = `å½“å‰: ${limit}`;

            // åº”ç”¨æ–°çš„ä¸Šé™ï¼Œè‹¥è¶…å‡ºåˆ™ç«‹å³è£å‰ª
            enforceCreatureLimit();
        }

        function enforceCreatureLimit() {
            if (isPruningCreatures) return;
            if (!Number.isFinite(creatureLimit) || creatureLimit < 1) return;
            if (creatures.length <= creatureLimit) return;

            isPruningCreatures = true;
            try {
                while (creatures.length > creatureLimit) {
                    const removed = creatures.shift(); // ç§»é™¤æœ€æ—©åŠ å…¥çš„
                    if (!removed) break;
                    const v = removed.video;
                    try { if (v && typeof v.pause === 'function') v.pause(); } catch (e) {}
                    try {
                        if (v && v.src && v.src.startsWith('blob:')) {
                            URL.revokeObjectURL(v.src);
                        }
                    } catch (e) {}
                    // å¯é€‰ï¼šä¸ä»å·²çŸ¥æ–‡ä»¶é›†åˆä¸­åˆ é™¤ï¼Œé¿å…è¢«å†æ¬¡é‡å¤åŠ è½½
                }
            } finally {
                // æ›´æ–°æ•°é‡æ˜¾ç¤º
                document.getElementById('creature-count').textContent = creatures.length;
                isPruningCreatures = false;
            }
        }

        // ===== æ’­æ”¾å®ˆæŠ¤ï¼šç¡®ä¿è§†é¢‘æŒç»­æ’­æ”¾ =====
        function setupGlobalPlaybackGuards() {
            if (playbackGuardsInitialized) return;
            playbackGuardsInitialized = true;

            // é¡µé¢é‡æ–°å¯è§æ—¶æ¢å¤æ’­æ”¾
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    playAllVideos();
                }
            });

            // æ¯0.5ç§’å·¡æ£€ä¸€æ¬¡ï¼ˆæ›´åŠæ—¶ï¼‰
            if (playbackWatchdogInterval) clearInterval(playbackWatchdogInterval);
            playbackWatchdogInterval = setInterval(() => {
                const now = performance.now() / 1000;
                for (const creature of creatures) {
                    const v = creature.video;
                    if (!v) continue;
                    // åˆå§‹åŒ–ä¸Šæ¬¡æ—¶é—´
                    if (v._lastT == null) v._lastT = 0;
                    if (v._lastCheck == null) v._lastCheck = 0;

                    const t = safeCurrentTime(v);

                    // è¿‘å°¾å¸§é¢„è·³è½¬ï¼šé¿å…å¡åœ¨å°¾å¸§
                    if (isNearEnd(v)) {
                        nudgePlay(v, 0.001);
                        continue;
                    }
                    // è‹¥æ’­æ”¾ç»“æŸï¼Œç«‹å³å›åˆ°èµ·ç‚¹å¹¶é‡æ’­
                    if (v.ended && v.loop !== false) {
                        nudgePlay(v, 0.001);
                        continue;
                    }
                    // å¦‚æœæš‚åœæˆ–å·²å…·å¤‡æ’­æ”¾æ¡ä»¶ï¼Œåˆ™å°è¯•æ’­æ”¾
                    if ((v.paused || v.readyState >= 2) && !v.ended) {
                        v.play().catch(() => {});
                    }

                    // å¡é¡¿æ£€æµ‹ï¼šæ’­æ”¾æ—¶é—´é•¿æ—¶é—´æœªå‰è¿›
                    if (Math.abs(t - v._lastT) < 0.001) {
                        if (!v._stallSince) v._stallSince = now;
                        if ((now - v._stallSince) > STALL_NUDGE_SECONDS) {
                            nudgePlay(v, t + NUDGE_JUMP_SECONDS);
                            v._stallSince = now;
                        }
                    } else {
                        v._stallSince = null;
                    }
                    v._lastT = t;
                    v._lastCheck = now;
                }
            }, 500);
        }

        function attachPlaybackGuards(video) {
            if (!video) return;
            // å¼ºåˆ¶ä¿æŒå¾ªç¯æ‰“å¼€
            video.loop = true;
            const tryPlay = () => {
                if (video && video.readyState >= 2 && !video.ended) {
                    video.play().catch(() => {});
                }
            };
            const restartIfEnded = () => {
                if (video.ended) {
                    nudgePlay(video, 0.001);
                }
            };
            const preWrap = () => {
                if (isNearEnd(video)) {
                    nudgePlay(video, 0.001);
                }
            };
            video.addEventListener('pause', tryPlay);
            video.addEventListener('waiting', tryPlay);
            video.addEventListener('stalled', tryPlay);
            video.addEventListener('suspend', tryPlay);
            video.addEventListener('emptied', tryPlay);
            video.addEventListener('canplay', tryPlay);
            video.addEventListener('loadeddata', tryPlay);
            video.addEventListener('ended', restartIfEnded);
            // timeupdateé¢‘ç‡è¶³å¤Ÿï¼Œç”¨äºè¿‘å°¾å¸§é¢„è·³è½¬
            video.addEventListener('timeupdate', preWrap);
            // å¯„ç”Ÿåœ¨å¸§çº§å›è°ƒä¸Šè¿›ä¸€æ­¥å¢å¼ºå®ˆæŠ¤
            attachFrameGuard(video);
            // åˆå§‹åŒ–é˜²å¡é¡¿çŠ¶æ€
            video._lastT = 0;
            video._lastCheck = performance.now() / 1000;
            video._stallSince = null;
        }

        function attachFrameGuard(video) {
            try {
                if (!('requestVideoFrameCallback' in video)) return;
                const onFrame = () => {
                    if (!video) return;
                    if (isNearEnd(video) || video.ended) {
                        nudgePlay(video, 0.001);
                    } else if ((video.paused || video.readyState >= 2) && !video.ended) {
                        video.play().catch(() => {});
                    }
                    try { video.requestVideoFrameCallback(onFrame); } catch (e) {}
                };
                video.requestVideoFrameCallback(onFrame);
            } catch (e) {}
        }

        function nudgePlay(video, newTime) {
            try {
                if (Number.isFinite(newTime)) {
                    const dur = video.duration;
                    if (isFinite(dur) && dur > 0) {
                        // é™åˆ¶åˆ°åˆæ³•èŒƒå›´
                        const target = Math.max(0.001, Math.min(dur - 0.01, newTime));
                        if (!isNaN(target)) video.currentTime = target;
                    } else {
                        video.currentTime = 0.001;
                    }
                } else {
                    video.currentTime = 0.001;
                }
            } catch (e) {}
            video.play().catch(() => {});
        }

        function safeCurrentTime(video) {
            try {
                return Number(video.currentTime) || 0;
            } catch (e) { return 0; }
        }

        function isNearEnd(video) {
            try {
                const dur = video.duration;
                if (!isFinite(dur) || dur <= 0) return false;
                const ct = video.currentTime || 0;
                return (dur - ct) <= LOOP_WRAP_THRESHOLD && !video.paused;
            } catch (e) { return false; }
        }

        // ===== File System Access API ç›®å½•æˆæƒä¸ç›´è¯»æšä¸¾ =====
        async function requestDirectoryAccess() {
            if (!('showDirectoryPicker' in window)) {
                alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒç›®å½•è®¿é—® APIï¼Œè¯·æ”¹ç”¨æ–¹æ¡ˆä¸‰ï¼ˆæœ¬åœ°HTTPæœåŠ¡ï¼‰æˆ–å‡çº§æµè§ˆå™¨ã€‚');
                return;
            }
            try {
                // è®©ç”¨æˆ·é€‰æ‹© video ç›®å½•
                const handle = await window.showDirectoryPicker({ mode: 'read' });
                // ç®€å•æ ¡éªŒæœ«çº§ç›®å½•å
                if (!handle || handle.kind !== 'directory') {
                    return;
                }
                dirHandle = handle;
                useFsAccess = true;
                const status = document.getElementById('dir-access-status');
                if (status) status.textContent = 'ç›®å½•è®¿é—®ï¼šå·²æˆæƒ (video)';
                showNewVideoNotification('å·²æˆæƒç›®å½•è®¿é—®ï¼šå¯ç”¨ç›®å½•ç›´è¯»ç›‘å¬');

                // ç«‹å³å¯åŠ¨/é‡å¯ç›‘å¬
                if (isMonitoring) {
                    if (videoMonitorInterval) clearInterval(videoMonitorInterval);
                    videoMonitorInterval = setInterval(() => {
                        enumerateDirectoryAndLoad();
                    }, monitorIntervalMs);
                    enumerateDirectoryAndLoad();
                } else {
                    startVideoMonitoring();
                }
            } catch (err) {
                console.warn('ç›®å½•æˆæƒè¢«å–æ¶ˆæˆ–å¤±è´¥', err);
            }
        }

        async function enumerateDirectoryAndLoad() {
            if (!dirHandle) return;
            try {
                const entries = [];
                // è¯»å–ç›®å½•æ¡ç›®
                for await (const [name, handle] of dirHandle.entries()) {
                    if (handle.kind === 'file' && name.toLowerCase().endsWith('.webm')) {
                        entries.push({ name, handle });
                    }
                }

                // ä¸å·²åŠ è½½åˆ—è¡¨åšå·®é›†
                const currentSet = new Set(entries.map(e => e.name));

                // 1) æ–°å¢æ–‡ä»¶ï¼šå°šæœªåŠ è½½çš„
                for (const { name, handle } of entries) {
                    if (loadedFilenames.has(name) || loadingFilenames.has(name)) {
                        continue;
                    }
                    loadingFilenames.add(name);
                    await loadFromFsFileHandle(handle, name);
                }

                // 2) å·²åˆ é™¤æ–‡ä»¶ï¼šå·²åŠ è½½ä½†ç›®å½•ä¸­ä¸å­˜åœ¨çš„ï¼Œéœ€ç§»é™¤
                const toRemove = [];
                creatures.forEach((creature, idx) => {
                    const v = creature.video;
                    const n = (v && v.dataset && v.dataset.filename)
                        ? v.dataset.filename
                        : (v && v.src ? v.src.split('/').pop() : null);
                    if (n && !currentSet.has(n)) {
                        toRemove.push({ idx, n });
                    }
                });

                if (toRemove.length > 0) {
                    // ä»åå¾€å‰ç§»é™¤ï¼Œé¿å…ç´¢å¼•é”™ä½
                    for (let i = toRemove.length - 1; i >= 0; i--) {
                        const { idx, n } = toRemove[i];
                        const video = creatures[idx].video;
                        if (video && video.src && video.src.startsWith('blob:')) {
                            URL.revokeObjectURL(video.src);
                        }
                        creatures.splice(idx, 1);
                        loadedFilenames.delete(n);
                        knownVideoFiles.delete(n);
                        knownVideoFiles.delete(`${n}_not_found`);
                        console.log(`ğŸ—‘ï¸ FS: ç›®å½•å·²åˆ é™¤ -> ç§»é™¤ ${n}`);
                    }
                    updateCreatureCount();
                }
            } catch (e) {
                console.warn('ç›®å½•æšä¸¾å¤±è´¥', e);
            }
        }

        async function loadFromFsFileHandle(fileHandle, filename) {
            try {
                const file = await fileHandle.getFile();
                // å¤§å°é™åˆ¶åŒä¸Šä¼ é€»è¾‘
                if (file.size > 50 * 1024 * 1024) return;
                const blobUrl = URL.createObjectURL(file);
                const video = document.createElement('video');
                video.src = blobUrl;
                video.loop = true;
                video.muted = true;
                video.autoplay = true;
                video.preload = 'auto';
                video.playsInline = true;
                // è®°å½•æ¥æºæ–‡ä»¶åï¼Œä¾¿äºå»é‡
                video.dataset.filename = filename;
                let handled = false;
                const onSuccess = () => {
                    if (handled) return;
                    if (video.videoWidth === 0 || video.videoHeight === 0) {
                        console.warn('FS: æ— æ•ˆè§†é¢‘å°ºå¯¸', filename);
                        URL.revokeObjectURL(blobUrl);
                        loadingFilenames.delete(filename);
                        return;
                    }
                    handled = true;
                    const creature = new Creature(video);
                    creatures.push(creature);
                    updateCreatureCount();
                    loadedFilenames.add(filename);
                    loadingFilenames.delete(filename);
                    knownVideoFiles.add(filename);
                    showNewVideoNotification(`æˆåŠŸåŠ è½½: ${filename}`);
                    attachPlaybackGuards(video);
                };
                video.addEventListener('loadedmetadata', onSuccess);
                video.addEventListener('canplay', onSuccess);
                video.addEventListener('loadeddata', onSuccess);

                video.addEventListener('error', () => {
                    if (handled) return;
                    handled = true;
                    console.warn('FS: åŠ è½½å¤±è´¥', filename);
                    URL.revokeObjectURL(blobUrl);
                    loadingFilenames.delete(filename);
                });
            } catch (e) {
                console.warn('FS: è¯»å–æ–‡ä»¶å¤±è´¥', filename, e);
            }
        }
    </script>
</body>
</html>
