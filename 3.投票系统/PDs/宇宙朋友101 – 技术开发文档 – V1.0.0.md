# 宇宙朋友101 – 技术开发文档 – V1.0.0

更新时间：2025-09-29
 文档命名规范建议采用“产品名称 – 文档类型 – 版本号”，并使用语义化版本号“主.次.修订”，例如本稿为“宇宙朋友101 – 技术开发文档 – V1.0.0”。当新增功能（例如新增统计维度）时递增次版本；文字与样式微调递增修订号；结构性调整（例如从纯前端改为含后端）递增主版本号 [2](https://www.woshipm.com/pd/6249512.html)。

本技术文档严格对齐用户提供的PRD，覆盖功能与非功能实现、数据模型、组件拆分、交互状态、关键算法与可测试验收点，确保“可落地、可维护、可验收”。同时明确关键流程节点，降低实现偏差 [2](https://www.woshipm.com/pd/6249512.html)。文档中非功能要求一并给出（如加载策略、响应式与可用性），以避免“只实现功能、不达体验”的常见风险 [2](https://www.woshipm.com/pd/6249512.html)。PRD强调“解决什么、如何做、如何验收”，本开发文档与其一一对应 [1](https://modao.cc/ad/blog/prd-document.html)。

------

## 1. 范围与目标

- 目标：基于 PRD 的纯前端单页应用（SPA），零依赖，无需服务器，支持本地打开 index.html 即可使用；支持本地投票与统计（localStorage）。
- 核心功能：
  - 随机抽取视频并渲染20张卡片（不足20则展示全部）。
  - 单次可选择1–3个视频；超过3个则禁用其他未选项；可取消已选。
  - 提交后本地票数自增并刷新20个卡片（不整页刷新）。
  - 查看统计（模态），降序展示投过票的视频与票数；可重置数据。
- 非目标：不含任何服务端/登录/多端同步；票数仅对本设备有效。

------

## 2. 运行环境与兼容性

- 运行：Chrome 90+、Edge 90+、Firefox 90+、Safari 15+，直接双击打开 index.html 即用。
- 视频支持：PRD指定 .webm；部分旧版Safari对WebM支持不佳（15+支持VP9/Opus更稳）。若设备/浏览器不支持，卡片会显示“无法播放”占位提示。
- 自动播放：视频元素加 muted + playsinline + autoplay + loop；移动端因策略限制，muted/playsinline 必须 [实践规范]。
- 性能预算（建议）：首屏渲染 ≤ 1s（不含视频解码）；视频 preload="metadata"；滚动可暂停非在视区视频，以降低CPU占用。非功能指标应前置明确 [2](https://www.woshipm.com/pd/6249512.html)。

------

## 3. 项目结构

- 最简文件结构（与PRD一致）：
  - /宇宙朋友101投票/
    - index.html
    - style.css
    - script.js
    - /videos/（放置所有 .webm 文件）
- 配置：在 script.js 内配置 ALL_VIDEOS 数组（相对路径）。

------

## 4. 数据模型与本地存储

- 存储介质：localStorage
- Key 与结构：
  - voteData: JSON字符串，形如 {"videos/CosmicFriend_001.webm": 5, "videos/Stardust_Explorer.webm": 12}
- 约束：
  - JSON解析失败时进行兜底（恢复为空对象）。
  - 清除数据通过 localStorage.removeItem('voteData')。
- 数据安全：仅本地浏览器存储，不上传；删除浏览器数据则清空票数。

------

## 5. 页面结构与组件

- Header：
  - 标题：宇宙朋友101：为你心动的TA投票！
  - 描述：支持1–3个选择的提示文案
  - 右上“查看票数统计”按钮
- 视频网格（#video-grid）：
  - 响应式Grid展示最多20张卡片
  - 卡片内容：<video>、作品编号（文件名前缀或去扩展名）、“投TA一票”按钮
- 底部操作区（固定/粘性）：
  - “确认提交我的投票（已选X/3）”主按钮：无选择时禁用
- 统计模态（#stats-modal）：
  - 表格容器：按票数降序
  - 重置数据按钮
  - 关闭按钮/遮罩关闭/Esc关闭
- Toast/提示：投票成功后展示。

------

## 6. 交互逻辑与状态机

- 状态：
  - selectedSet: Set<string>，本轮已选择视频路径
  - currentBatch: string[]，当前展示的20个视频路径
- 行为与规则：
  - 点击投票按钮：
    - 若该视频未选且 selectedSet.size < 3：加入；否则若已选则移除。
    - 当已选=3时，禁用其他未选按钮；已选按钮始终可点击以取消。
    - 按钮样式通过 .selected 切换；同时维护 aria-pressed。
  - 提交：
    - 若 selectedSet.size >= 1：读取 voteData，逐个 +1；写回；Toast；刷新新20个卡片；selectedSet清空。
  - 统计：
    - 打开模态：读取 voteData，构建降序表格；无数据显示“暂无数据”。
    - 重置：二次确认后清除 voteData 并刷新视图。
- 关键节点均需在代码/文档中明确（选择、禁用、提交、统计、重置、刷新），有助于降低缺陷率 [2](https://www.woshipm.com/pd/6249512.html)。

------

## 7. 随机抽取逻辑

- 算法：Fisher–Yates 洗牌 ALL_VIDEOS 副本，取前20个（ALL_VIDEOS < 20 则全取）。
- 复杂度：O(N)
- 备注：PRD未要求“避免与上轮重复”，因此不做跨轮去重；如需可用 sessionStorage 记录上一批，优先取差集，不足再补齐。

------

## 8. 非功能与性能（建议）

- 加载策略：
  - video preload="metadata"，减少首帧压力；
  - 使用 IntersectionObserver 将不在视区的视频暂停（可选增强）。
- 响应式与适配：
  - CSS Grid + aspect-ratio，支持手机至桌面。
- 可用性：
  - 按钮 hover/active/disabled 状态清晰；提交按钮显示已选数量。
- 性能指标与规范写入文档有助于发布质量与协作效率 [2](https://www.woshipm.com/pd/6249512.html)。

------

## 9. 无障碍与可访问性

- aria：
  - 投票按钮 aria-pressed 单选/取消
  - 模态 role="dialog" aria-modal="true" aria-labelledby
- 键盘：
  - Tab 顺序可达；Esc 关闭模态；Enter 触发按钮
- 对比度：遵循深色背景+霓虹高对比主题

------

## 10. 错误处理与边界

- ALL_VIDEOS 为空：网格显示提示“未找到视频，请先配置 ALL_VIDEOS”
- 某视频加载失败：卡片显示“视频无法播放”占位与禁用投票按钮
- 解析 voteData 失败：自动清空并重建（避免页面不可用）
- 浏览器不支持 WebM：统一显示占位文案（提示使用Chrome/Edge/Firefox或新版本Safari）

------

## 11. 开发任务清单与建议排期

- D0 基础：项目骨架、样式主题变量、栅格布局（0.5 天）
- D1 功能：随机渲染/卡片/选择上限/按钮禁用/提交写入localStorage（0.5 天）
- D2 统计：模态、降序表格、重置逻辑（0.5 天）
- D3 体验：Toast、可访问性、移动端适配、错误兜底（0.5 天）
- D4 测试与验收：覆盖测试用例、Bug修复（0.5 天）

------

## 12. 测试用例与验收标准

- 初始渲染：加载后出现 ≤20 张卡片；若 ALL_VIDEOS<20 则展示全部。
- 选择上限：第4个不同视频按钮被禁用；取消任意已选后恢复可选。
- 提交投票：至少选择1个后提交生效；localStorage 中对应键值 +1；Toast 出现；卡片刷新（不整页刷新）。
- 统计排序：模态中按票数降序；无数据时显示“暂无数据”。
- 重置：确认后 voteData 被移除；统计视图清空。
- 无障碍：Tab 可到达所有可交互元素；Esc 关闭模态。
- 异常：破损/不可解码视频显示占位并禁用投票按钮，不影响其他卡片与提交。

------

## 13. 部署与分享

- 使用：直接用浏览器打开 index.html
- 分享：将项目文件夹打包为 ZIP；对方解压后可直接使用；票数仅与其设备相关（localStorage）

------

## 14. 变更与版本规范

- 文档命名与版本管理遵循“产品名称 – 文档类型 – 版本号”，语义化版本控制“主.次.修订”。主版本用于架构性变更，次版本用于功能新增，修订用于描述优化与小修 [2](https://www.woshipm.com/pd/6249512.html)。

------

## 15. 代码骨架（可直接落地）

请将以下三段保存为 index.html、style.css、script.js，并在 script.js 中配置 ALL_VIDEOS。

### index.html

```
    html
    <!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>宇宙朋友101：为你心动的TA投票！</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preload" href="style.css" as="style" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="app-header">
    <div class="title-wrap">
      <h1>宇宙朋友101：为你心动的TA投票！</h1>
      <p class="subtitle">欢迎来到我的宇宙朋友画廊！请为你最喜欢的 1-3 位宇宙朋友投上宝贵的一票。</p>
    </div>
    <button id="btn-stats" class="btn btn-secondary">查看票数统计</button>
  </header>

  <main>
    <div id="video-grid" class="video-grid" aria-live="polite" aria-busy="true"></div>
  </main>

  <footer class="app-footer">
    <button id="btn-submit" class="btn btn-primary" disabled>
      确认提交我的投票（已选 0/3）
    </button>
  </footer>

  <!-- 统计模态框 -->
  <div id="stats-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="stats-title" hidden>
    <div class="modal-backdrop" data-close="1"></div>
    <div class="modal-content">
      <header class="modal-header">
        <h2 id="stats-title">票数统计</h2>
        <button class="btn btn-icon" id="btn-close-stats" aria-label="关闭统计">✕</button>
      </header>
      <section class="modal-body">
        <div id="stats-table-wrap" class="table-wrap">加载中…</div>
      </section>
      <footer class="modal-footer">
        <button id="btn-reset" class="btn btn-danger">重置我的投票记录</button>
      </footer>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite" hidden></div>

  <script src="script.js"></script>
</body>
</html>

  
```

### style.css

```
    css
    :root{
  --bg: #0b0f1a;
  --bg-2: #0f1330;
  --card: #121a2b;
  --text: #e6f2ff;
  --muted: #9fb3c8;
  --accent: #00e5ff; /* 霓虹青 */
  --accent-2: #ff00d4; /* 霓虹紫 */
  --danger: #ff4d4f;
  --border: rgba(255,255,255,.08);
  --shadow: 0 10px 30px rgba(0,0,0,.45), 0 0 30px rgba(0,229,255,.06);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, PingFang SC, Noto Sans SC, "Microsoft YaHei", Arial, sans-serif;
  color: var(--text);
  background:
    radial-gradient(1200px 800px at 20% -10%, rgba(0,229,255,.08), transparent 60%),
    radial-gradient(1000px 700px at 80% 0%, rgba(255,0,212,.08), transparent 60%),
    linear-gradient(180deg, var(--bg), var(--bg-2));
}

.app-header{
  position: sticky; top:0; z-index: 10;
  display:flex; align-items:center; justify-content:space-between;
  padding: 16px 20px;
  border-bottom:1px solid var(--border);
  background: linear-gradient(180deg, rgba(15,19,48,.9), rgba(15,19,48,.7));
  backdrop-filter: blur(6px);
}
.title-wrap h1{margin:0; font-size:20px; letter-spacing:.5px;}
.subtitle{margin:.25rem 0 0; color: var(--muted); font-size: 14px;}

.video-grid{
  padding: 16px;
  display:grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}
@media (min-width:640px){
  .video-grid{grid-template-columns: repeat(3, 1fr);}
}
@media (min-width:960px){
  .video-grid{grid-template-columns: repeat(4, 1fr);}
}
.card{
  background: linear-gradient(180deg, rgba(18,26,43,.9), rgba(18,26,43,.7));
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow:hidden;
  box-shadow: var(--shadow);
  display:flex; flex-direction:column;
}
.card-video{
  width:100%;
  aspect-ratio: 16/9;
  background: radial-gradient(ellipse at center, rgba(255,255,255,.05), transparent 60%);
  object-fit: cover;
}
.card-body{ padding: 10px; display:flex; align-items:center; justify-content:space-between; gap:8px; }
.card-title{ margin:0; font-size: 14px; color: var(--text); overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }

.btn{
  display:inline-flex; align-items:center; justify-content:center; gap:6px;
  height:36px; padding: 0 12px;
  border-radius: 8px; border:1px solid transparent;
  background: rgba(255,255,255,.04); color: var(--text);
  cursor:pointer; transition: all .2s ease;
}
.btn:hover{ background: rgba(255,255,255,.08); }
.btn:disabled{ opacity:.45; cursor:not-allowed; }

.btn-primary{
  background: linear-gradient(90deg, var(--accent), var(--accent-2));
  color: #001018; font-weight: 600;
  border: none;
}
.btn-secondary{
  border-color: rgba(255,255,255,.14);
}
.btn-danger{
  background: linear-gradient(90deg, #ff7875, #ff4d4f);
  border: none; color:#1a0000; font-weight:600;
}
.btn-icon{
  width:36px; height:36px; padding:0;
  background: transparent; border:1px solid rgba(255,255,255,.18);
}

.btn-vote.selected{
  box-shadow: 0 0 12px rgba(0,229,255,.7) inset, 0 0 16px rgba(255,0,212,.35);
  border-color: rgba(0,229,255,.7);
  background: linear-gradient(90deg, rgba(0,229,255,.2), rgba(255,0,212,.2));
}

.app-footer{
  position: sticky; bottom:0; z-index: 9;
  display:flex; justify-content:center;
  padding: 12px 16px; border-top:1px solid var(--border);
  background: linear-gradient(0deg, rgba(15,19,48,.9), rgba(15,19,48,.7));
  backdrop-filter: blur(6px);
}

.modal[hidden]{ display:none; }
.modal{ position: fixed; inset:0; z-index: 20; }
.modal-backdrop{
  position:absolute; inset:0; background: rgba(0,0,0,.55);
}
.modal-content{
  position:absolute; inset:auto; left:50%; top:50%;
  transform: translate(-50%, -50%);
  width:min(92vw, 820px);
  background: linear-gradient(180deg, rgba(18,26,43,.98), rgba(18,26,43,.92));
  border:1px solid var(--border); border-radius: 12px; overflow:hidden;
}
.modal-header, .modal-footer{
  padding: 12px 14px; border-bottom:1px solid var(--border);
}
.modal-footer{ border-top:1px solid var(--border); border-bottom:none; }
.modal-body{ padding: 12px 14px; max-height: 70vh; overflow:auto; }
.table-wrap{ width:100%; overflow:auto; }
table{ width:100%; border-collapse: collapse; }
th, td{ padding: 10px 8px; border-bottom:1px solid var(--border); text-align:left; }
th{ color: var(--muted); font-weight:600; }

.toast[hidden]{ display:none; }
.toast{
  position: fixed; left:50%; bottom: 28px; transform: translateX(-50%);
  background: rgba(0,0,0,.75); color:#fff; padding:10px 14px; border-radius: 10px;
  border:1px solid rgba(255,255,255,.18); box-shadow: var(--shadow);
  z-index: 30;
}

.placeholder{
  display:flex; align-items:center; justify-content:center;
  width:100%; aspect-ratio: 16/9; color: var(--muted); font-size: 13px;
  background: repeating-linear-gradient(45deg, rgba(255,255,255,.04), rgba(255,255,255,.04) 10px, transparent 10px, transparent 20px);
}

  
```

### script.js

```
    js
    // ==== 0) 配置区 ====
// 在此数组中手动填入视频的相对路径（与 index.html 同级或 videos/ 子目录）
const ALL_VIDEOS = [
  // 示例（请替换为你自己的文件列表）
  'videos/CosmicFriend_001.webm',
  'videos/CosmicFriend_002.webm',
  'videos/Stardust_Explorer.webm',
  'videos/Galaxy_Dancer.webm',
  // ... 继续添加
];

const STORAGE_KEY = 'voteData';

// ==== 1) DOM 引用 ====
const grid = document.getElementById('video-grid');
const btnSubmit = document.getElementById('btn-submit');
const btnStats = document.getElementById('btn-stats');

const modal = document.getElementById('stats-modal');
const modalBackdrop = modal.querySelector('.modal-backdrop');
const btnCloseStats = document.getElementById('btn-close-stats');
const statsTableWrap = document.getElementById('stats-table-wrap');
const btnReset = document.getElementById('btn-reset');

const toast = document.getElementById('toast');

// ==== 2) 状态 ====
let selectedSet = new Set();     // 当前选择
let currentBatch = [];           // 当前展示的视频列表（最多20）

// ==== 3) 工具 ====
function safeParse(json, fallback = {}) {
  try { return JSON.parse(json); } catch { return fallback; }
}
function readVotes() {
  const raw = localStorage.getItem(STORAGE_KEY);
  const obj = safeParse(raw, {});
  return (obj && typeof obj === 'object' && !Array.isArray(obj)) ? obj : {};
}
function writeVotes(obj) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
}
function showToast(msg = '操作成功', ms = 1200) {
  toast.textContent = msg;
  toast.hidden = false;
  setTimeout(() => { toast.hidden = true; }, ms);
}
function fileBaseName(path) {
  const seg = path.split('/').pop() || path;
  return seg.replace(/\.[^.]+$/, ''); // 去扩展名
}
function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}
function updateSubmitButton() {
  const count = selectedSet.size;
  btnSubmit.disabled = count === 0;
  btnSubmit.textContent = `确认提交我的投票（已选 ${count}/3）`;
}
function updateVoteButtonsDisabled() {
  const count = selectedSet.size;
  const btns = grid.querySelectorAll('.btn-vote');
  btns.forEach(btn => {
    const video = btn.dataset.video;
    const isSelected = selectedSet.has(video);
    btn.disabled = !isSelected && count >= 3;
  });
}

// ==== 4) 渲染卡片 ====
function createCard(videoSrc) {
  const card = document.createElement('div');
  card.className = 'card';

  // 视频
  let videoEl = document.createElement('video');
  videoEl.className = 'card-video';
  videoEl.src = videoSrc;
  videoEl.autoplay = true;
  videoEl.muted = true;
  videoEl.loop = true;
  videoEl.playsInline = true; // iOS
  videoEl.preload = 'metadata';
  videoEl.disablePictureInPicture = true;
  videoEl.controls = false;

  // 出错占位
  videoEl.addEventListener('error', () => {
    const placeholder = document.createElement('div');
    placeholder.className = 'placeholder';
    placeholder.textContent = '该视频无法播放';
    card.replaceChild(placeholder, videoEl);
    // 将对应按钮禁用
    const btn = card.querySelector('.btn-vote');
    if (btn) btn.disabled = true;
  });

  // body
  const body = document.createElement('div');
  body.className = 'card-body';

  const title = document.createElement('p');
  title.className = 'card-title';
  title.textContent = fileBaseName(videoSrc);

  const btn = document.createElement('button');
  btn.className = 'btn btn-vote';
  btn.type = 'button';
  btn.textContent = '投TA一票';
  btn.dataset.video = videoSrc;
  btn.setAttribute('aria-pressed', 'false');

  body.appendChild(title);
  body.appendChild(btn);

  card.appendChild(videoEl);
  card.appendChild(body);

  return card;
}

function displayRandomVideos() {
  grid.setAttribute('aria-busy', 'true');
  grid.innerHTML = '';

  if (!ALL_VIDEOS || ALL_VIDEOS.length === 0) {
    const tip = document.createElement('div');
    tip.className = 'placeholder';
    tip.textContent = '未找到视频，请先在 script.js 配置 ALL_VIDEOS。';
    grid.appendChild(tip);
    grid.setAttribute('aria-busy', 'false');
    return;
  }

  const list = shuffle([...ALL_VIDEOS]);
  currentBatch = list.slice(0, Math.min(20, list.length));
  selectedSet.clear();
  updateSubmitButton();

  const frag = document.createDocumentFragment();
  currentBatch.forEach(src => frag.appendChild(createCard(src)));
  grid.appendChild(frag);

  updateVoteButtonsDisabled();
  grid.setAttribute('aria-busy', 'false');
}

// ==== 5) 事件绑定 ====
// 委托处理投票选择
grid.addEventListener('click', (e) => {
  const btn = e.target.closest('.btn-vote');
  if (!btn) return;
  const video = btn.dataset.video;
  if (!video) return;

  const isSelected = selectedSet.has(video);

  if (isSelected) {
    selectedSet.delete(video);
    btn.classList.remove('selected');
    btn.setAttribute('aria-pressed', 'false');
  } else {
    if (selectedSet.size >= 3) {
      // 已达上限，不处理（按钮会被禁用，通常不会走到这里）
      return;
    }
    selectedSet.add(video);
    btn.classList.add('selected');
    btn.setAttribute('aria-pressed', 'true');
  }

  updateSubmitButton();
  updateVoteButtonsDisabled();
});

// 提交投票
btnSubmit.addEventListener('click', () => {
  if (selectedSet.size === 0) return;

  const votes = readVotes();
  for (const v of selectedSet) {
    votes[v] = (votes[v] || 0) + 1;
  }
  writeVotes(votes);
  showToast('投票成功！页面即将刷新，展示新的朋友们！');

  // 清空选择，刷新卡片（不整页刷新）
  selectedSet.clear();
  updateSubmitButton();

  // 短暂延迟以展示Toast
  setTimeout(() => {
    displayRandomVideos();
  }, 600);
});

// 统计模态
btnStats.addEventListener('click', () => {
  openStats();
});
modalBackdrop.addEventListener('click', (e) => {
  if (e.target.dataset.close) closeStats();
});
btnCloseStats.addEventListener('click', closeStats);
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && !modal.hidden) closeStats();
});

btnReset.addEventListener('click', () => {
  const ok = confirm('确定要重置本设备的投票记录吗？此操作不可恢复。');
  if (!ok) return;
  localStorage.removeItem(STORAGE_KEY);
  buildStatsTable(); // 刷新视图
  showToast('已重置投票记录');
});

// ==== 6) 统计 ====
function openStats() {
  buildStatsTable();
  modal.hidden = false;
  // 聚焦可达性
  btnCloseStats.focus();
}
function closeStats() {
  modal.hidden = true;
  btnStats.focus();
}
function buildStatsTable() {
  const votes = readVotes();
  const entries = Object.entries(votes); // [ [path, count], ... ]
  if (entries.length === 0) {
    statsTableWrap.innerHTML = '<div class="placeholder">暂无数据</div>';
    return;
  }

  // 按票数降序
  entries.sort((a, b) => b[1] - a[1]);

  const rows = entries.map(([path, count]) => {
    const name = fileBaseName(path);
    return `<tr><td title="${path}">${name}</td><td>${count}</td></tr>`;
  }).join('');

  statsTableWrap.innerHTML = `
    <table aria-describedby="stats-title">
      <thead><tr><th>视频</th><th>票数</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

// ==== 7) 启动 ====
document.addEventListener('DOMContentLoaded', () => {
  displayRandomVideos();
});

  
```

------

## 16. 可进一步增强（可选）

- 懒加载与离屏暂停：IntersectionObserver 自动暂停离屏视频，节能减噪。
- 服务工作线程（Service Worker）：提供离线缓存与更快的二次打开（仍为纯前端）。
- 反重复策略：使用 sessionStorage 记录上一批路径，尽量不重复抽取。
- 指标埋点（本地模拟或接入开源静态埋点）：用于后续优化，如按钮点击次数、投票转化路径等。规范指标有助于AB测试与可信度 [2](https://www.woshipm.com/pd/6249512.html)。